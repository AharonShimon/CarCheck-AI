<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <style>
        :root { 
            --primary: #00F2FF; --accent: #7000FF; --bg: #0A0A0C; --card: #16161D; 
            --text: #E0E0E0; --danger: #FF3B3B; --success: #00FF85; --warning: #FFB800; 
        }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; -webkit-tap-highlight-color: transparent; }
        .container { padding: 20px; max-width: 500px; margin: auto; padding-bottom: 90px; }

        /* ×œ×•×—×™×ª ×¨×™×©×•×™ */
        .plate-container { 
            background: #FFB800; padding: 5px; border-radius: 12px; border: 3px solid #000; 
            display: flex; align-items: center; position: relative; margin-bottom: 15px;
            box-shadow: 0 4px 15px rgba(255, 184, 0, 0.2);
        }
        .plate-input { 
            background: none; border: none; font-size: 38px; font-weight: 900; width: 100%; 
            text-align: center; outline: none; letter-spacing: 4px; font-family: monospace; color: #000; z-index: 2;
        }
        .il-tag { 
            background: #003399; color: white; padding: 4px 8px; border-radius: 4px; 
            font-size: 11px; position: absolute; left: 8px; font-weight: bold; 
            display: flex; flex-direction: column; align-items: center; line-height: 1;
        }

        /* ××œ×× ×˜×™× ×›×œ×œ×™×™× */
        select, input, .btn { 
            width: 100%; padding: 16px; background: var(--card); border: 1px solid #333; 
            color: #fff; border-radius: 14px; margin-bottom: 15px; font-size: 16px; 
            box-sizing: border-box; transition: 0.2s;
        }
        .btn { background: #007AFF; font-weight: bold; cursor: pointer; border: none; font-size: 18px; color: white; }
        .btn-ai { background: linear-gradient(135deg, var(--primary), var(--accent)); margin-top: 10px; }
        .btn-finish { background: var(--success); color: #000; margin-top: 30px; font-weight: 800; }

        /* ×ª×•×¦××•×ª AI */
        #ai-result { display: none; margin-top: 20px; animation: fadeIn 0.5s ease; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .ai-gauge { 
            width: 90px; height: 90px; border-radius: 50%; border: 6px solid #333;
            display: flex; align-items: center; justify-content: center;
            font-size: 32px; font-weight: 900; margin: 0 auto 10px auto;
            background: rgba(255,255,255,0.03); box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        .ai-card { 
            background: rgba(255,255,255,0.05); padding: 16px; border-radius: 12px; 
            border-right: 4px solid #555; font-size: 15px; line-height: 1.5; margin-bottom: 10px;
        }
        .ai-card h3 { margin: 0 0 8px 0; font-size: 16px; display: flex; align-items: center; gap: 8px; }
        .ai-card ul { margin: 0; padding-right: 20px; }
        .card-bad { border-right-color: var(--danger); } .card-bad h3 { color: var(--danger); }
        .card-good { border-right-color: var(--success); } .card-good h3 { color: var(--success); }
        .card-info { border-right-color: var(--primary); } .card-info h3 { color: var(--primary); }

        /* ×¦'×§ ×œ×™×¡×˜ */
        .category { margin-top: 30px; color: var(--primary); font-size: 18px; font-weight: 800; border-bottom: 2px solid #222; padding-bottom: 8px; }
        .check-item { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .cb { width: 26px; height: 26px; border: 2px solid #555; border-radius: 8px; margin-left: 15px; flex-shrink: 0; }
        .cb.checked { background: var(--danger); border-color: var(--danger); display: flex; align-items: center; justify-content: center; }
        .cb.checked::after { content: "âœ•"; color: white; font-weight: bold; }
        
        /* ×œ×•××“×¨ */
        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ××¡×š ×¡×™×•× */
        #score-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 25px; }
        .score-circle { width: 150px; height: 150px; border-radius: 50%; border: 8px solid var(--success); display: flex; align-items: center; justify-content: center; font-size: 55px; font-weight: 900; color: var(--success); margin-bottom: 25px; box-shadow: 0 0 30px rgba(0, 255, 133, 0.2); }
        
        /* ×”×¡×ª×¨×ª ××œ×× ×˜×™× */
        .tooltip { display: none; background: #222; padding: 12px; border-radius: 10px; font-size: 13px; color: #ccc; margin-top: 5px; border: 1px solid #444; }
        .info-btn { width: 32px; height: 32px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner"></div>
    <p id="loader-text" style="color:white; margin-top:15px; font-weight:bold;">××¢×‘×“ × ×ª×•× ×™×...</p>
</div>

<div id="screen-input" class="container">
    <h1 style="text-align:center;">CarCheck AI <span style="color:var(--primary)">PRO</span></h1>
    
    <div class="plate-container">
        <div class="il-tag"><span>×™×©×¨××œ</span><span>IL</span></div>
        <input id="plate" class="plate-input" type="tel" placeholder="12345678" maxlength="8">
    </div>
    
    <button class="btn" onclick="superSearch()">ğŸ” ××™×ª×•×¨ ×¨×›×‘ (×××©×œ×ª×™)</button>
    <div id="status-msg" style="text-align:center; min-height:20px; font-weight:bold; margin-top:10px;"></div>

    <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
        <label style="color:#888; display:block; margin-bottom:5px;">×™×¦×¨×Ÿ:</label>
        <select id="brand" onchange="updateModels()"><option value="">×‘×—×¨ ×™×¦×¨×Ÿ...</option></select>
        
        <label style="color:#888; display:block; margin-bottom:5px;">×“×’×:</label>
        <input id="model" list="model-list" placeholder="×‘×—×¨ ××• ×”×§×œ×“..." disabled>
        <datalist id="model-list"></datalist>
        
        <label style="color:#888; display:block; margin-bottom:5px;">×©× ×”:</label>
        <input id="year" type="number" placeholder="×œ××©×œ: 2022">
        
        <button class="btn btn-ai" onclick="analyzeAI()">ğŸ¤– ×”×¤×¢×œ × ×™×ª×•×— AI</button>
    </div>

    <div id="ai-result"></div>
</div>

<div id="screen-check" class="container" style="display:none">
    <h2 id="check-header" style="text-align:center;"></h2>
    <div id="checklist-content"></div>
    <button class="btn btn-finish" onclick="calculateScore()">ğŸ“Š ×§×‘×œ ×¦×™×•×Ÿ ×¡×•×¤×™</button>
</div>

<div id="score-overlay">
    <div class="score-circle" id="final-score">0</div>
    <h2 id="score-msg" style="color:white; margin:0;"></h2>
    <p id="score-desc" style="color:#aaa; max-width:300px; margin-bottom:30px; line-height:1.5;"></p>
    <button class="btn" style="background:#25D366; color:white;" onclick="shareResult()">×©×ª×£ ×‘×•×•××˜×¡××¤ ğŸŸ¢</button>
    <button class="btn" style="background:#333; margin-top:15px;" onclick="location.reload()">×‘×“×™×§×” ×—×“×©×”</button>
</div>

<script>
const carDatabase = {
    "×××•×“×™": ["A1", "A3", "A4", "Q3", "Q5", "e-tron"],
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "CH-R", "RAV4", "×œ× ×“ ×§×¨×•×–×¨", "×¤×¨×™×•×¡", "××™×™×’×•"],
    "×™×•× ×“××™": ["i10", "i20", "i30", "××™×•× ×™×§", "×˜×•×¡×•×Ÿ", "×¡× ×˜×” ×¤×”", "××œ× ×˜×¨×”", "×•× ×™×•"],
    "×××–×“×”": ["2", "3", "6", "CX-3", "CX-5", "CX-30"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¨×™×•", "×¤×•×¨×˜×”", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§", "×¡×•×¨× ×˜×•", "×§×¨× ×™×‘×œ"],
    "×¡×§×•×“×”": ["××•×§×˜×‘×™×”", "×¡×•×¤×¨×‘", "×§×××™×§", "×§×•×“×™××§", "×¤××‘×™×”"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "×•×™×˜××¨×”", "×§×¨×•×¡××•×‘×¨", "×’'×™×× ×™", "××™×’× ×™×¡"],
    "××™×¦×•×‘×™×©×™": ["×××•×˜×œ× ×“×¨", "ASX", "×¡×¤×™×™×¡ ×¡×˜××¨"],
    "×¡×™××˜": ["××™×‘×™×–×”", "×œ××•×Ÿ", "××¨×•× ×”", "××˜×§×”"],
    "×¨× ×•": ["×§×œ×™××•", "×§×¤×¦'×•×¨", "××’××Ÿ", "×’×¨× ×“ ×§×•×¤×”"],
    "×©×‘×¨×•×œ×˜": ["×¡×¤××¨×§", "×××œ×™×‘×•", "×˜×¨××§×¡"],
    "×”×•× ×“×”": ["×¡×™×•×•×™×§", "×’'××–", "CR-V", "HR-V"],
    "×˜×¡×œ×”": ["Model 3", "Model Y"]
};

const checklistData = {
    "×× ×•×¢": [{name:"×˜×—×™× ×” ×‘×©××Ÿ",tip:"×‘×“×•×§ ×‘××“×™×“ ×•×‘×¤×§×§ ××™×œ×•×™"},{name:"× ×•×–×œ ×§×™×¨×•×¨",tip:"×—×œ×•×“×” ××• ×©××Ÿ ×‘××™×?"},{name:"× ×–×™×œ×•×ª",tip:"××ª×—×ª ×œ×¨×›×‘ ×•×¢×œ ×”×‘×œ×•×§"},{name:"×¨×¢×©/×¢×™×©×•×Ÿ",tip:"×ª×§×ª×•×§×™× ××• ×¢×©×Ÿ ×œ×‘×Ÿ/×›×—×•×œ"}],
    "×’×™×¨ ×•×©×œ×“×”": [{name:"××›×•×ª ×‘×’×™×¨",tip:"×‘××¢×‘×¨ ×”×™×œ×•×›×™×"},{name:"×”×—×œ×§×”",tip:"×˜×•×¨×™× ×¢×•×œ×™× ×œ×œ× ×”××¦×”"},{name:"×ª××•× ×•×ª",tip:"×”×¤×¨×©×™ ×¦×‘×¢, ×¨×•×•×—×™× ×œ× ××—×™×“×™×"},{name:"×¦××™×’×™×",tip:"×™×‘×©×™× ××• ×©×—×•×§×™×?"}],
    "×—×©××œ": [{name:"××–×’×Ÿ",tip:"×”×× ××§×¨×¨ ×—×–×§?"},{name:"× ×•×¨×•×ª ××–×”×¨×”",tip:"×”×× ×“×•×œ×§×•×ª × ×•×¨×•×ª ×‘×œ×•×—?"},{name:"×—×œ×•× ×•×ª",tip:"×”×× ×¢×•×œ×™× ×•×™×•×¨×“×™× ×—×œ×§?"}]
};

const brandSel = document.getElementById('brand');
Object.keys(carDatabase).sort().forEach(b => brandSel.innerHTML += `<option value="${b}">${b}</option>`);

function updateModels() {
    const b = brandSel.value;
    const list = document.getElementById('model-list');
    const input = document.getElementById('model');
    list.innerHTML = ''; input.value = '';
    if(b && carDatabase[b]) { input.disabled = false; carDatabase[b].forEach(m => list.innerHTML += `<option value="${m}">`); } 
    else { input.disabled = true; }
}

async function superSearch() {
    let p = document.getElementById('plate').value.replace(/\D/g,'');
    if(p.length < 7) return alert("××¡×¤×¨ ×©×’×•×™");
    document.getElementById('loader').style.display = 'flex';
    document.getElementById('status-msg').innerHTML = "";
    try {
        const url = `https://data.gov.il/api/3/action/datastore_search?resource_id=053ad243-5e8b-4334-8397-47883b740881&filters={"mispar_rechev":"${p}"}`;
        const res = await fetch(`https://corsproxy.io/?` + encodeURIComponent(url));
        const data = await res.json();
        if(data.result.records.length > 0) {
            const c = data.result.records[0];
            document.getElementById('year').value = c.shnat_yitzur;
            let rawBrand = c.tozeret_nm || "";
            for(let opt of brandSel.options) { if(rawBrand.includes(opt.value) && opt.value !== "") { brandSel.value = opt.value; updateModels(); break; } }
            document.getElementById('model').value = c.kinuy_mishari || "";
            document.getElementById('status-msg').innerHTML = "<span style='color:var(--success)'>âœ… ×¨×›×‘ ××•×ª×¨!</span>";
        } else { document.getElementById('status-msg').innerHTML = "<span style='color:var(--warning)'>âš ï¸ ×œ× × ××¦×, ×”×–×Ÿ ×™×“× ×™×ª</span>"; }
    } catch(e) { document.getElementById('status-msg').innerHTML = "<span style='color:var(--danger)'>âŒ ×©×’×™××ª ×ª×§×©×•×¨×ª</span>"; } 
    finally { document.getElementById('loader').style.display = 'none'; }
}

async function analyzeAI() {
    const b = brandSel.value, m = document.getElementById('model').value, y = document.getElementById('year').value;
    if(!b || !m || !y) return alert("×—×¡×¨×™× ×¤×¨×˜×™×");
    document.getElementById('loader').style.display = 'flex';
    
    try {
        const res = await fetch('/analyze-ai', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({brand:b, model:m, year:y}) });
        const data = await res.json();
        
        if(data.success) {
            const ai = data.aiAnalysis;
            const resDiv = document.getElementById('ai-result');
            let color = ai.reliability_score >= 80 ? 'var(--success)' : (ai.reliability_score >= 60 ? 'var(--warning)' : 'var(--danger)');
            
            resDiv.innerHTML = `
                <div style="text-align:center; margin-bottom:15px;">
                    <div class="ai-gauge" style="border-color:${color}; color:${color}">${ai.reliability_score}</div>
                    <div style="font-size:14px; color:#aaa">×¦×™×•×Ÿ ×××™× ×•×ª</div>
                </div>
                <div class="ai-card card-info"><h3>ğŸ“Œ ×¡×™×›×•×</h3><p>${ai.summary}</p></div>
                <div class="ai-card card-bad"><h3>âš ï¸ ××—×œ×•×ª</h3><ul>${ai.common_faults.map(f=>`<li>${f}</li>`).join('')}</ul></div>
                <div class="ai-card card-good"><h3>âœ… ×™×ª×¨×•× ×•×ª</h3><ul>${ai.pros.map(p=>`<li>${p}</li>`).join('')}</ul></div>
                <button class="btn" style="margin-top:20px; background:#333; border:1px solid #555" onclick="goToChecklist()">×”××©×š ×œ×‘×“×™×§×” ×¤×™×–×™×ª â”</button>
            `;
            resDiv.style.display = 'block';
            setTimeout(() => resDiv.scrollIntoView({behavior:"smooth"}), 100);
        }
    } catch(e) { alert("AI ×œ× ×–××™×Ÿ ×›×¨×’×¢, ×××©×™×›×™× ×œ×‘×“×™×§×”."); goToChecklist(); } 
    finally { document.getElementById('loader').style.display = 'none'; }
}

function goToChecklist() {
    document.getElementById('screen-input').style.display = 'none';
    document.getElementById('screen-check').style.display = 'block';
    document.getElementById('check-header').innerText = `${brandSel.value} ${document.getElementById('model').value}`;
    let h = "", i = 0;
    for(let cat in checklistData) {
        h += `<div class="category">${cat}</div>`;
        checklistData[cat].forEach(item => { i++; h += `<div class="check-item"><div class="item-left" onclick="toggleCB(${i})"><div class="cb" id="cb_${i}"></div><span>${item.name}</span></div><div class="info-btn" onclick="toggleTip(${i})">?</div></div><div class="tooltip" id="tip_${i}">${item.tip}</div>`; });
    }
    document.getElementById('checklist-content').innerHTML = h;
    window.scrollTo(0,0);
}

function toggleCB(id) { document.getElementById('cb_'+id).classList.toggle('checked'); }
function toggleTip(id) { const el = document.getElementById('tip_'+id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; }
function calculateScore() {
    const total = document.querySelectorAll('.cb').length;
    const checked = document.querySelectorAll('.cb.checked').length;
    const score = Math.max(0, 100 - Math.round((checked/total)*100));
    document.getElementById('final-score').innerText = score;
    const msg = document.getElementById('score-msg');
    if(score > 85) msg.innerText = "×¨×›×‘ ××•××œ×¥ âœ…";
    else if(score > 60) msg.innerText = "××¦×‘ ×¡×‘×™×¨ âš ï¸";
    else msg.innerText = "×œ× ××•××œ×¥ âŒ";
    document.getElementById('score-overlay').style.display = 'flex';
}
function shareResult() { window.open(`https://wa.me/?text=${encodeURIComponent('×ª×•×¦××ª ×‘×“×™×§×”: '+document.getElementById('final-score').innerText)}`); }
</script>
</body>
</html>
