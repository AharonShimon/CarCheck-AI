<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-deep:#0f172a; --bg-gradient-start:#0f172a; --bg-gradient-end:#1e293b; --card-bg:rgba(30,41,59,0.85); --card-border:rgba(148,163,184,0.15); --accent:#38bdf8; --accent-glow:rgba(56,189,248,0.3); --text-main:#f8fafc; --text-muted:#94a3b8; --danger:#ef4444; --success:#10b981; --plate-yellow:#facc15; }
        body { font-family: 'Heebo', sans-serif; background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%); color: var(--text-main); margin: 0; direction: rtl; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .container { padding: 24px; width: 100%; max-width: 480px; box-sizing: border-box; padding-bottom: 120px; }
        header { text-align: center; margin: 20px 0 30px 0; }
        header h1 { font-size: 28px; font-weight: 900; letter-spacing: 1px; margin: 0; text-transform: uppercase; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        header h1 span { background: linear-gradient(to right, var(--accent), #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 20px var(--accent-glow); }
        .plate-box { background: var(--plate-yellow); padding: 4px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin: 0 auto 30px auto; width: 100%; max-width: 320px; position: relative; }
        .plate-inner { border: 3px solid #1e293b; border-radius: 8px; display: flex; align-items: center; padding: 0 10px; height: 60px; background: var(--plate-yellow); }
        .plate-inner::before { content: "IL"; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; width: 25px; height: 100%; background: #003399; border-radius: 4px 0 0 4px; margin-left: 10px; }
        .plate-input { background: none; border: none; font-size: 42px; font-weight: 800; width: 100%; text-align: center; outline: none; letter-spacing: 4px; font-family: monospace; color: #1e293b; height: 100%; padding-top: 5px; }
        .field-group { margin-bottom: 20px; width: 100%; position: relative; }
        label { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 8px; display: block; padding-right: 5px; opacity: 0.9; }
        .selector-trigger { width: 100%; height: 64px; background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--card-border); border-radius: 16px; color: #fff; font-size: 17px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; transition: all 0.2s ease; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .selector-trigger:active { transform: scale(0.98); background: rgba(30, 41, 59, 0.9); }
        .selector-trigger.disabled { opacity: 0.5; pointer-events: none; }
        .arrow { color: var(--accent); font-size: 12px; }
        .popup-grid { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid var(--card-border); border-radius: 16px; padding: 12px; z-index: 9999; margin-top: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); max-height: 380px; overflow-y: auto; border: 1px solid var(--accent); }
        .popup-grid.active { display: block; animation: slideUp 0.25s cubic-bezier(0.16, 1, 0.3, 1); }
        .search-input { width: 100%; padding: 14px; margin-bottom: 12px; background: #0f172a; border: 1px solid var(--card-border); border-radius: 10px; color: white; font-size: 16px; box-sizing: border-box; text-align: right; outline: none; }
        .search-input:focus { border-color: var(--accent); }
        .grid-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-item { padding: 12px 4px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 14px; font-weight: 500; cursor: pointer; color: var(--text-muted); border: 1px solid transparent; min-height: 48px; display: flex; align-items: center; justify-content: center; line-height: 1.2; word-break: break-word; transition: 0.2s; }
        .grid-item:hover { background: var(--accent); color: #000; font-weight: 700; }
        .grid-loader { grid-column: 1/-1; text-align: center; padding: 20px; color: var(--accent); display:flex; justify-content:center; align-items:center; gap:10px; }
        .manual-entry { grid-column: 1 / -1; background: rgba(56, 189, 248, 0.15); color: var(--accent); border: 1px dashed var(--accent); }
        .btn-main { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 17px; font-weight: 700; cursor: pointer; color: white; background: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%); box-shadow: 0 10px 25px -5px rgba(37, 99, 235, 0.4); margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; transition: transform 0.1s; letter-spacing: 0.5px; }
        .btn-outline { background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); margin-top: 15px; color: var(--text-muted); width: 100%; padding: 16px; border-radius: 16px; font-size: 16px; font-weight: 600; cursor: pointer; }
        
        #screen-check { display: none; width: 100%; flex-direction: column; align-items: center; }
        .category-header { width: 100%; margin: 35px 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: right; }
        .category-title { color: var(--accent); font-size: 19px; font-weight: 800; text-transform: uppercase; }
        .check-item { width: 100%; background: var(--card-bg); backdrop-filter: blur(10px); border-radius: 16px; margin-bottom: 14px; border: 1px solid var(--card-border); display: flex; flex-direction: column; box-sizing: border-box; transition: transform 0.1s; }
        .check-item-header { display: flex; justify-content: space-between; align-items: center; width: 100%; padding: 18px; box-sizing: border-box; }
        .right-side { display: flex; align-items: center; gap: 15px; flex-grow: 1; justify-content: flex-start; }
        .info-btn { width: 30px; height: 30px; border-radius: 50%; background: rgba(56, 189, 248, 0.15); color: var(--accent); display: flex; align-items: center; justify-content: center; font-size: 18px; font-weight: bold; cursor: pointer; flex-shrink: 0; font-family: 'Times New Roman', serif; font-style: italic; border: 1px solid rgba(56, 189, 248, 0.3); }
        .item-name { font-weight: 600; font-size: 16px; color: var(--text-main); text-align: right; line-height: 1.3; }
        .cb-custom { width: 30px; height: 30px; border: 2px solid #475569; border-radius: 8px; cursor: pointer; background: transparent; display: flex; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .cb-custom.bad { background: var(--danger); border-color: var(--danger); transform: scale(1.1); box-shadow: 0 0 15px rgba(239, 68, 68, 0.4); } 
        .cb-custom.bad:after { content: 'âœ•'; color: white; font-weight: 900; font-size: 20px; }
        .how-to-box { display: none; background: rgba(15, 23, 42, 0.8); border-top: 1px solid var(--card-border); padding: 18px; font-size: 14px; color: var(--text-muted); line-height: 1.6; text-align: right; border-bottom-left-radius: 16px; border-bottom-right-radius: 16px; }
        .ok-text { color: var(--success); display: block; margin-top: 10px; font-weight: 600; background: rgba(16, 185, 129, 0.1); padding: 8px; border-radius: 8px; border-right: 3px solid var(--success); }
        .not-ok-text { color: var(--danger); display: block; margin-top: 6px; font-weight: 600; background: rgba(239, 68, 68, 0.1); padding: 8px; border-radius: 8px; border-right: 3px solid var(--danger); }
        #screen-result { display: none; flex-direction: column; align-items: center; text-align: center; width: 100%; }
        .final-gauge { width: 180px; height: 180px; border-radius: 50%; border: 12px solid var(--card-border); display: flex; align-items: center; justify-content: center; font-size: 68px; font-weight: 900; margin: 30px auto; color: #fff; background: var(--card-bg); transition: all 0.8s ease; }
        .defects-list { width: 100%; text-align: right; background: rgba(239, 68, 68, 0.08); border: 1px solid rgba(239, 68, 68, 0.2); border-radius: 16px; padding: 20px; margin-bottom: 25px; display: none; box-sizing: border-box; }
        .defects-title { color: var(--danger); font-weight: 800; font-size: 16px; margin-bottom: 10px; display: block; } .defects-ul { margin: 0; padding-right: 20px; color: #fca5a5; font-size: 15px; line-height: 1.6; }
        #loader { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(5px); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .orbit { width: 60px; height: 60px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s infinite linear; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity:0; transform:translateY(15px); } to { opacity:1; transform:translateY(0); } }
    </style>
</head>
<body>

<div id="loader"><div class="orbit"></div><div style="margin-top:20px; color:var(--accent); font-weight:600;">ğŸ¤– ×× ×ª×— ×‘-AI...</div></div>

<div id="screen-input" class="container">
    <header><h1>ğŸš— CarCheck <span>PRO</span></h1></header>
    <div class="plate-box"><div class="plate-inner"><input id="plate" class="plate-input" type="tel" placeholder="00000000" maxlength="8"></div></div>
    
    <div class="field-group">
        <label>1. ×™×¦×¨×Ÿ ×¨×›×‘</label>
        <div id="brand-trigger" class="selector-trigger" onclick="window.handlePicker('brand')"><span>ğŸš˜ ×‘×—×¨ ×™×¦×¨×Ÿ...</span> <span class="arrow">â–¼</span></div>
        <div id="brand-popup" class="popup-grid">
            <input type="text" class="search-input" placeholder="×—×¤×© ×™×¦×¨×Ÿ..." onkeyup="window.filterGrid('brand', this.value)">
            <div id="brand-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-b">
    </div>

    <div class="field-group">
        <label>2. ×“×’×</label>
        <div id="model-trigger" class="selector-trigger disabled" onclick="window.handlePicker('model')"><span>ğŸï¸ ×‘×—×¨ ×“×’×...</span> <span class="arrow">â–¼</span></div>
        <div id="model-popup" class="popup-grid">
            <input type="text" class="search-input" placeholder="×—×¤×© ×“×’×..." onkeyup="window.filterGrid('model', this.value)">
            <div id="model-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-m">
    </div>

    <div class="field-group">
        <label>3. ×©× ×ª ×™×™×¦×•×¨</label>
        <div id="year-trigger" class="selector-trigger disabled" onclick="window.handlePicker('year')"><span>ğŸ“… ×‘×—×¨ ×©× ×”...</span> <span class="arrow">â–¼</span></div>
        <div id="year-popup" class="popup-grid">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; padding:0 10px; font-weight:bold; color:var(--accent);">
                <span onclick="event.stopPropagation(); window.shiftY(-1)">â®</span><span id="y-range-text"></span><span onclick="event.stopPropagation(); window.shiftY(1)">â¯</span>
            </div>
            <div id="year-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-y">
    </div>

    <div class="field-group">
        <label>4. ×ª×ª-×“×’× (× ×˜×¢×Ÿ ××”-AI ×œ×¤×™ ×”×©× ×”)</label>
        <div id="submodel-trigger" class="selector-trigger disabled" onclick="window.handlePicker('submodel')"><span>âš™ï¸ ×‘×—×¨ ×ª×ª-×“×’×...</span> <span class="arrow">â–¼</span></div>
        <div id="submodel-popup" class="popup-grid">
            <div id="submodel-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-s">
    </div>
    
    <button class="btn-main" onclick="window.startDeepAI()">ğŸš€ × ×ª×— × ×ª×•× ×™× ×‘-AI</button>
    <button class="btn-main btn-outline" onclick="window.goToChecklist()">ğŸ“‹ ×“×œ×’ ×œ×‘×“×™×§×” ×™×“× ×™×ª</button>
    <div id="ai-panel" style="margin-top: 30px;"></div>
</div>

<div id="screen-check" class="container">
    <header><h1>ğŸ“‹ ×‘×“×™×§×ª <span>×©×˜×—</span></h1></header>
    <div id="checklist-content" style="width: 100%;"></div>
    <div style="position:fixed; bottom:0; left:0; right:0; background:rgba(15, 23, 42, 0.95); backdrop-filter:blur(10px); padding:20px; border-top:1px solid var(--card-border); z-index:100;">
        <button class="btn-main" style="background: var(--success); color: #fff; margin:0;" onclick="window.finishCheck()">ğŸ“Š ×¡×™×™× ×‘×“×™×§×”</button>
    </div>
</div>

<div id="screen-result" class="container">
    <header><h1>ğŸ† ×ª×•×¦××•×ª</h1></header>
    <div id="final-gauge" class="final-gauge">0</div>
    <div id="result-text" style="font-size:22px; margin-bottom:25px; font-weight:700;"></div>
    <div id="defects-container" class="defects-list"><span class="defects-title">âš ï¸ ×œ×™×§×•×™×™×:</span><ul id="defects-ul" class="defects-ul"></ul></div>
    <button class="btn-main" style="background: #0ea5e9;" onclick="window.findGarage()">ğŸ—ºï¸ × ×•×•×˜ ×œ××›×•×Ÿ ×‘×“×™×§×”</button>
    <button class="btn-main btn-outline" onclick="location.reload()">ğŸ”„ ×”×ª×—×œ ××—×“×©</button>
</div>

<script>
// === 1. ×××’×¨ ×™×¦×¨× ×™× ×•×“×’××™× ××§×•××™ ===
const carData = {
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "RAV4", "C-HR", "×œ× ×“ ×§×¨×•×–×¨", "×¤×¨×™×•×¡", "×”×™×™×œ×§×¡", "×§×××¨×™", "××™×™×’×• X"],
    "×™×•× ×“××™": ["i10", "i20", "i30", "××™×•× ×™×§ 5", "××™×•× ×™×§ 6", "×˜×•×¡×•×Ÿ", "×¡× ×˜×” ×¤×”", "×§×•× ×”", "××œ× ×˜×¨×”", "×‘××™×•×Ÿ", "×¡×•× ×˜×”"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§", "×¡×•×¨× ×˜×•", "×§×¨× ×™×‘×œ", "EV6", "×¨×™×•", "×¡×™×“", "××•×¤×˜×™××”", "×¡×œ×˜×•×¡"],
    "×××–×“×”": ["2", "3", "6", "CX-3", "CX-5", "CX-30", "CX-60", "CX-9", "MX-5"],
    "×¡×§×•×“×”": ["××•×§×˜×‘×™×”", "×¡×•×¤×¨×‘", "×§×•×“×™××§", "×§××¨×•×§", "×§×××™×§", "×¤××‘×™×”", "×× ×™×™××§", "×¡×§××œ×”"],
    "×¤×•×œ×§×¡×•×•×’×Ÿ": ["×’×•×œ×£", "×¤×•×œ×•", "×˜×™×’×•××Ÿ", "×¤××¡××˜", "ID.4", "T-Roc", "×˜×•×¨××Ÿ", "×’'×˜×”", "T-Cross"],
    "×¡×™××˜": ["××™×‘×™×–×”", "×œ××•×Ÿ", "××¨×•× ×”", "××˜×§×”", "×˜×¨××§×•"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "×•×™×˜××¨×”", "×’'×™×× ×™", "×§×¨×•×¡××•×‘×¨", "×‘××œ× ×•", "××™×’× ×™×¡", "××œ×˜×•", "×¡×œ×¨×™×•"],
    "×¡×•×‘××¨×•": ["XV", "×¤×•×¨×¡×˜×¨", "×××•×˜×‘×§", "××™××¤×¨×–×”", "B4", "×§×¨×•×¡×˜×¨×§", "××‘×•×œ×˜×™×¡"],
    "×”×•× ×“×”": ["×¡×™×•×•×™×§", "×’'××–", "CR-V", "HR-V", "××§×•×¨×“"],
    "××™×¦×•×‘×™×©×™": ["×××•×˜×œ× ×“×¨", "ASX", "×¡×¤×™×™×¡ ×¡×˜××¨", "××§×œ×™×¤×¡ ×§×¨×•×¡", "×˜×¨×™×˜×•×Ÿ", "×œ× ×¡×¨"],
    "× ×™×¡××Ÿ": ["×§×©×§××™", "×’'×•×§", "××§×¡×˜×¨×™×™×œ", "××™×§×¨×”", "×¡× ×˜×¨×”"],
    "×©×‘×¨×•×œ×˜": ["×¡×¤××¨×§", "×˜×¨××•×•×¨×¡", "××§×•×•×™× ×•×§×¡", "×‘×œ×™×™×–×¨", "×¡×™×œ×‘×¨×“×•", "×××œ×™×‘×•", "×§×¨×•×–", "×˜×¨××§×¡"],
    "BYD": ["Atto 3", "Dolphin", "Seal"],
    "×’'×™×œ×™": ["Geometry C"],
    "MG": ["MG4", "ZS EV", "EHS", "Marvel R", "MG3"],
    "×˜×¡×œ×”": ["Model 3", "Model Y", "Model S", "Model X"],
    "×¦'×¨×™": ["FX", "Tiggo 7 Pro", "Tiggo 8 Pro"],
    "×××•×“×™": ["A1", "A3", "A4", "A5", "A6", "Q2", "Q3", "Q5", "Q7"],
    "×‘.×.×•×•": ["×¡×“×¨×” 1", "×¡×“×¨×” 3", "×¡×“×¨×” 5", "X1", "X3", "X5", "X6"],
    "××¨×¦×“×¡": ["A-Class", "C-Class", "E-Class", "GLA", "GLC", "GLE"],
    "×¤×™×’'×•": ["208", "2008", "3008", "5008", "308"],
    "×¨× ×•": ["×§×œ×™××•", "×§×¤×¦'×•×¨", "××’××Ÿ", "×’×¨× ×“ ×§×•×¤×”", "××¨×§× ×”", "××•×¡×˜×¨×œ"],
    "×¡×™×˜×¨×•××Ÿ": ["C3", "C4", "C5 Aircross", "×‘×¨×œ×™× ×’×•"]
};

// === 2. ×¦'×§×œ×™×¡×˜ ××œ× (35 ×¡×¢×™×¤×™×) ===
const checklistData = [
    {
        category: "ğŸ”© ×× ×•×¢ ×•××¢×¨×›×ª ×§×™×¨×•×¨ (×§×¨×™×˜×™)",
        items: [
            { name: "ğŸ›¢ï¸ ×¤×§×§ ××™×œ×•×™ ×©××Ÿ ('×˜×—×™× ×”')", weight: 25, howTo: "ğŸ“ ××™×§×•×: ×¨××© ×”×× ×•×¢.<br>ğŸ‘€ ×¤×¢×•×œ×”: ×¤×ª×— ×•×—×¤×© ×§×¦×£ ×œ×‘×Ÿ.", ok: "âœ… ×ª×§×™×Ÿ: ×¤×§×§ × ×§×™, ×©×—×•×¨ ××• ×—×•×.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×§×¦×£ ×œ×‘×Ÿ (×›××• ××™×•× ×–)." },
            { name: "ğŸ«§ ×‘×•×¢×•×ª ×‘××™×›×œ ×¢×™×‘×•×™", weight: 25, howTo: "ğŸ“ ××™×§×•×: ××™×›×œ ×¤×œ×¡×˜×™×§ ×©×§×•×£.<br>ğŸ‘€ ×¤×¢×•×œ×”: ×× ×•×¢ ×¢×•×‘×“ - ×™×© ×‘×•×¢×•×ª ×‘××™×?", ok: "âœ… ×ª×§×™×Ÿ: ××™× ×©×§×˜×™×.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×‘×•×¢×•×ª ××•×•×™×¨ ×¢×•×œ×•×ª (×›××• ×’'×§×•×–×™)." },
            { name: "ğŸŒ¬ï¸ × ×©×™××ª ×× ×•×¢ (Blow-By)", weight: 25, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”× ×— ×¤×§×§ ×”×¤×•×š ×¢×œ ×”×¤×ª×—. ×”×•× ×¢×£?", ok: "âœ… ×ª×§×™×Ÿ: ×”×¤×§×§ ×¨×•×¢×“ ×§×œ×•×ª ×‘××§×•×.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×”×¤×§×§ ×¢×£ ××”×œ×—×¥." },
            { name: "â›½ ×¨×™×— ×“×œ×§ ×—×¨×™×£", weight: 25, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¨×— ×¡×‘×™×‘ ×”×× ×•×¢ ×•×‘×ª×•×š ×”×¨×›×‘.", ok: "âœ… ×ª×§×™×Ÿ: ××™×Ÿ ×¨×™×— ×“×œ×§.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¨×™×— ×—×¨×™×£ ×©×œ ×‘× ×–×™×Ÿ." },
            { name: "âš« ×‘×•×¥ ×©××Ÿ (Sludge)", weight: 20, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”××¨ ×œ×¤× ×™× ×”×× ×•×¢. ×’×•×©×™× ×©×—×•×¨×™×?", ok: "âœ… ×ª×§×™×Ÿ: × ×§×™ ×•×–×”×•×‘.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ××©×§×¢×™× ×©×—×•×¨×™× ×•×¡××™×›×™×." },
            { name: "ğŸ“ ××“×™×“ ×©××Ÿ (××¤×œ×¡ ×•×¦×‘×¢)", weight: 15, howTo: "ğŸ“ ××™×§×•×: ×™×“×™×ª ×¦×”×•×‘×”/×›×ª×•××”.<br>ğŸ‘€ ×¤×¢×•×œ×”: ×‘×“×•×§ ×’×•×‘×” ×•×¦×‘×¢.", ok: "âœ… ×ª×§×™×Ÿ: ×¦×‘×¢ ×“×‘×©/×—×•×, ××¤×œ×¡ ×ª×§×™×Ÿ.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×©××Ÿ ×©×—×•×¨ ××“×™ ××• ×—×¡×¨." },
            { name: "ğŸ’§ × ×–×™×œ×•×ª ×©××Ÿ ×˜×¨×™×•×ª", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¡×ª×›×œ ××ª×—×ª ×œ×¨×›×‘ ×•×¢×œ ×”×‘×œ×•×§.", ok: "âœ… ×ª×§×™×Ÿ: ×× ×•×¢ ×™×‘×© ×•××‘×§×ª×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¨×˜×™×‘×•×ª ×©××Ÿ ×˜×¨×™×™×” ×•××‘×¨×™×§×”." },
            { name: "ğŸ§ª ×¦×‘×¢ × ×•×–×œ ×§×™×¨×•×¨", weight: 10, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×‘×˜ ×‘××™×›×œ ×”×¢×™×‘×•×™.", ok: "âœ… ×ª×§×™×Ÿ: × ×•×–×œ ××§×•×¨×™ (×™×¨×•×§/×•×¨×•×“/×›×—×•×œ).", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ××™ ×‘×¨×– ×©×§×•×¤×™× ××• ×¦×‘×¢ ×—×œ×•×“×”." },
            { name: "ğŸ”Š ×¨×¢×© ×× ×•×¢ (×ª×§×ª×•×§×™×)", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×§×©×‘ ×œ×× ×•×¢ ×‘×¡×¨×§.", ok: "âœ… ×ª×§×™×Ÿ: ×¢×‘×•×“×” ×¢×’×•×œ×” ×•×©×§×˜×”.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×ª×§×ª×•×§×™× ××ª×›×ª×™×™× ×—×–×§×™×." },
            { name: "âœŠ ×œ×—×¥ ×‘×¦× ×¨×ª ×¨×“×™××˜×•×¨", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×›×©×”×× ×•×¢ ×—×, ×œ×—×¥ ×¢×œ ×”×¦×™× ×•×¨ ×”×¢×œ×™×•×Ÿ.", ok: "âœ… ×ª×§×™×Ÿ: ×’××™×© ××¢×˜ ×‘×œ×—×™×¦×”.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×§×©×” ×›××• ××‘×Ÿ." },
            { name: "ğŸŒ€ ×××•×•×¨×¨ ×¨×“×™××˜×•×¨", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¤×¢×œ ××–×’×Ÿ. ×××•×•×¨×¨ ×¢×•×‘×“?", ok: "âœ… ×ª×§×™×Ÿ: ×¢×•×‘×“ ×—×–×§ ××™×“.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×”×××•×•×¨×¨ ×œ× ××¡×ª×•×‘×‘." }
        ]
    },
    {
        category: "âš™ï¸ ×’×™×¨ ×•×”× ×¢×”",
        items: [
            { name: "ğŸ¥Š ××›×” ×‘×©×™×œ×•×‘ ×”×™×œ×•×š", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¢×‘×¨ P-D-R. ×™×© ×“×¤×™×§×”?", ok: "âœ… ×ª×§×™×Ÿ: ×©×™×œ×•×‘ ×—×œ×§.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×“×¤×™×§×” ×—×–×§×” ××• ×§×¤×™×¦×”." },
            { name: "â›¸ï¸ ×”×—×œ×§×” ×‘×”××¦×”", weight: 20, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×’×– ×—×–×§ - ×˜×•×¨×™× ×¢×•×œ×™× ×‘×œ×™ ×ª××•×¦×”?", ok: "âœ… ×ª×§×™×Ÿ: ×ª××•×¦×” ××™×™×“×™×ª.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×”×× ×•×¢ ×¦×•×¢×§ ×•×”×¨×›×‘ ×œ× ×–×–." },
            { name: "ğŸ«¨ ×¨×¢×™×“×•×ª ×‘× ×¡×™×¢×”", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×¡×¢ ×‘-100 ×§×\"×©.", ok: "âœ… ×ª×§×™×Ÿ: × ×¡×™×¢×” ×—×œ×§×”.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×”×”×’×” ××• ×”×¨×›×‘ ×¨×•×¢×“×™×." },
            { name: "ğŸ”© ×¨×¢×©×™ ×¦×™×¨×™×•×ª", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×¡×™×‘×•×‘ ×”×’×” ××œ× ×‘× ×¡×™×¢×”. ×¨×¢×©?", ok: "âœ… ×ª×§×™×Ÿ: ×©×§×˜ ××•×—×œ×˜.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¨×¢×© ×ª×§×ª×•×§×™× (×§×œ×™×§-×§×œ×™×§)." },
            { name: "ğŸ©¸ ××¦×‘ ×©××Ÿ ×’×™×¨", weight: 10, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×× ×™×© ××“×™×“ - ×‘×“×•×§ ×¦×‘×¢.", ok: "âœ… ×ª×§×™×Ÿ: ××“×•×/×‘×”×™×¨ ×•× ×§×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×©××Ÿ ×©×—×•×¨ ×•×©×¨×•×£." }
        ]
    },
    {
        category: "ğŸ› ï¸ ×©×œ×“×” ×•××¨×›×‘",
        items: [
            { name: "ğŸ§² ××‘×—×Ÿ ×”××’× ×˜", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ××’× ×˜ × ×•×¤×œ ××”×¤×—? (×©×¤×›×˜×œ).", ok: "âœ… ×ª×§×™×Ÿ: × ×¦××“ ×—×–×§.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×”××’× ×˜ ×œ× × ×¦××“." },
            { name: "ğŸ”¥ × ×§×•×“×•×ª ×¨×™×ª×•×š", weight: 20, howTo: "ğŸ“ ××™×§×•×: ×ª×—×ª ×”×’×•××™×•×ª.<br>ğŸ‘€ ×¤×¢×•×œ×”: × ×§×•×“×•×ª ×¢×’×•×œ×•×ª?", ok: "âœ… ×ª×§×™×Ÿ: × ×§×•×“×•×ª ××§×•×¨×™×•×ª.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×©×˜×— ×—×œ×§ ××• ××•×©×—×–." },
            { name: "ğŸ”§ ×‘×¨×’×™ ×›× ×¤×™×™×", weight: 12, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×¦×‘×¢ ××§×•×œ×£ ×¢×œ ×”×‘×¨×’×™×?", ok: "âœ… ×ª×§×™×Ÿ: ×¦×‘×¢ ××§×•×¨×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¡×™×× ×™ ×¤×ª×™×—×” ×•×©×¨×™×˜×•×ª." },
            { name: "ğŸŒŠ ×¨×˜×™×‘×•×ª ×‘×ª× ××˜×¢×Ÿ", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¨× ×©×˜×™×—. ×™×© ××™×?", ok: "âœ… ×ª×§×™×Ÿ: ×™×‘×© ×œ×’××¨×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¨×˜×™×‘×•×ª ××• ×—×œ×•×“×”." },
            { name: "ğŸ¨ ×”×‘×“×œ×™ ×’×•×•×Ÿ", weight: 10, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¡×ª×›×œ ×‘×©××© ×¢×œ ×”×“×œ×ª×•×ª.", ok: "âœ… ×ª×§×™×Ÿ: ×¦×‘×¢ ××—×™×“.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×”×‘×“×œ×™× ×‘×™×Ÿ ×—×œ×§×™×." },
            { name: "ğŸ“ ×¡×™××˜×¨×™×” ×‘××¨×•×•×—×™×", weight: 10, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×‘×“×•×§ ×¨×•×•×—×™× ×‘××›×¡×” ×× ×•×¢.", ok: "âœ… ×ª×§×™×Ÿ: ×¨×•×•×—×™× ×©×•×•×™×.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¦×“ ××—×“ ×¨×—×‘ ××”×©× ×™." },
            { name: "ğŸ¦€ ×—×œ×•×“×” ×‘×ª×—×ª×™×ª", weight: 15, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×ª×›×•×¤×£ ×•×”×¡×ª×›×œ ×œ××˜×”.", ok: "âœ… ×ª×§×™×Ÿ: × ×§×™ ××¨×™×§×‘×•×Ÿ.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×—×œ×•×“×” ××ª×¤×•×¨×¨×ª." }
        ]
    },
    {
        category: "âš¡ ×—×©××œ ×•×¤× ×™×",
        items: [
            { name: "ğŸ’¡ × ×•×¨×•×ª ××–×”×¨×”", weight: 20, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×× × ×•×¨×” ×“×•×œ×§×ª ×§×‘×•×¢?", ok: "âœ… ×ª×§×™×Ÿ: ×œ×•×— × ×§×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: × ×•×¨×ª ×× ×•×¢/×›×¨×™×ª ××•×•×™×¨ ×“×•×œ×§×ª." },
            { name: "â„ï¸ ××–×’×Ÿ (×§×•×¨)", weight: 10, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ××§×¤×™× ××™×“?", ok: "âœ… ×ª×§×™×Ÿ: ×§×•×¨ ×—×–×§.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×œ× ××§×¨×¨ ××¡×¤×™×§." },
            { name: "ğŸ”¥ ×—×™××•×", weight: 10, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ××•×¦×™× ×—×•×?", ok: "âœ… ×ª×§×™×Ÿ: ××—×× ×—×–×§.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×™×•×¦× ××•×•×™×¨ ×§×¨." },
            { name: "ğŸªŸ ×—×œ×•× ×•×ª ×—×©××œ", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×‘×“×•×§ ××ª ×›×œ ×”-4.", ok: "âœ… ×ª×§×™×Ÿ: ×¢×•×œ×™× ×—×œ×§.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×—×œ×•×Ÿ ×ª×§×•×¢ ××• ××™×˜×™." },
            { name: "ğŸ”’ × ×¢×™×œ×” ××¨×›×–×™×ª", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: × ×¢×œ ×•×¤×ª×—.", ok: "âœ… ×ª×§×™×Ÿ: ×”×›×œ × × ×¢×œ.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×“×œ×ª ××—×ª ×œ× × × ×¢×œ×ª." },
            { name: "ğŸ’º ××¦×‘ ×¨×™×¤×•×“×™×", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×§×¨×¢×™× ××• ×©×§×™×¢×”?", ok: "âœ… ×ª×§×™×Ÿ: ×©×œ× ×•× ×§×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×§×¨×¢×™× ××• ×›×ª××™×." },
            { name: "ğŸ› × ×–×§×™ ×”×¦×¤×”", weight: 20, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×¨× ×©×˜×™×—, ×—×¤×© ×‘×•×¥.", ok: "âœ… ×ª×§×™×Ÿ: × ×§×™ ×•×™×‘×©.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×—×•×œ, ×‘×•×¥ ××• ×—×œ×•×“×”." }
        ]
    },
    {
        category: "ğŸ› ×¦××™×’×™× ×•×‘×˜×™×—×•×ª",
        items: [
            { name: "ğŸ“… ×ª××¨×™×š ×¦××™×’×™×", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×—×¤×© 4 ×¡×¤×¨×•×ª (×œ××©×œ 1023).", ok: "âœ… ×ª×§×™×Ÿ: ×¢×“ 4 ×©× ×™×.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¦××™×’ ×™×©×Ÿ ×-4 ×©× ×™×." },
            { name: "ğŸŒµ ×™×•×‘×© ×‘×¦××™×’×™×", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×—×¤×© ×¡×“×§×™×.", ok: "âœ… ×ª×§×™×Ÿ: ×’×•××™ ×˜×¨×™.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×¡×“×§×™× ×•×™×•×‘×©." },
            { name: "ğŸ© ×’×œ×’×œ ×¨×–×¨×‘×™", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×‘×“×•×§ ×‘×‘×’××–'.", ok: "âœ… ×ª×§×™×Ÿ: ×§×™×™× ×•×ª×§×™×Ÿ.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×—×¡×¨ ×’×œ×’×œ ××• ×¢×¨×›×”." },
            { name: "ğŸ—ï¸ ×—×’×•×¨×•×ª ×‘×˜×™×—×•×ª", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ××©×•×š ×—×–×§ - × × ×¢×œ?", ok: "âœ… ×ª×§×™×Ÿ: × × ×¢×œ ××™×“.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ×œ× × × ×¢×œ ××• ×§×¨×•×¢." },
            { name: "ğŸŒ§ï¸ ×•×™×©×¨×™× ×•××ª×™×–×™×", weight: 5, howTo: "ğŸ‘€ ×¤×¢×•×œ×”: ×”×©×¤×¨×¥ ××™×.", ok: "âœ… ×ª×§×™×Ÿ: ×× ×§×™× ×˜×•×‘.", notOk: "âŒ ×œ× ×ª×§×™×Ÿ: ××•×¨×—×™× ××• ×™×‘×©×™×." }
        ]
    }
];

let yBase = 2018; let currentScore = 100; let badItemsNames = [];

window.handlePicker = async function(type) {
    const trigger = document.getElementById(type + '-trigger');
    if (trigger.classList.contains('disabled')) return;
    
    document.querySelectorAll('.popup-grid').forEach(p => p.classList.remove('active'));
    document.getElementById(type + '-popup').classList.add('active');

    const grid = document.getElementById(type + '-grid');
    if (grid.children.length > 0 && type !== 'year' && type !== 'submodel') return;

    if (type === 'brand') {
        renderGrid('brand', Object.keys(carData));
    } else if (type === 'model') {
        const brand = document.getElementById('val-b').value;
        renderGrid('model', carData[brand] || []);
    } else if (type === 'year') {
        renderYears();
    } else if (type === 'submodel') {
        // === ×©×•×œ×—×™× ××ª ×”×©× ×” ×™×—×“ ×¢× ×”×™×¦×¨×Ÿ ×•×”×“×’× ===
        const brand = document.getElementById('val-b').value;
        const model = document.getElementById('val-m').value;
        const year = document.getElementById('val-y').value;
        await fetchOptions(brand, model, year, grid);
    }
};

async function fetchOptions(brand, model, year, gridElement) {
    gridElement.innerHTML = '<div class="grid-loader"><div class="orbit" style="width:20px;height:20px;border-width:2px;"></div> ×˜×•×¢×Ÿ ×-AI...</div>';
    try {
        const res = await fetch('/get-car-options', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ brand, model, year }) // ×©×œ×™×—×ª ×”×©× ×”!
        });
        const data = await res.json();
        
        if (data.success && Array.isArray(data.options)) {
            renderGrid('submodel', data.options, gridElement);
        } else {
            gridElement.innerHTML = '<div style="grid-column:1/-1;text-align:center;">×œ× × ××¦××• ×“×’××™×.</div>';
        }
    } catch (e) {
        gridElement.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:red;">×©×’×™××ª ×ª×§×©×•×¨×ª</div>';
    }
}

function renderGrid(type, items, targetElement = null) {
    const g = targetElement || document.getElementById(type + '-grid');
    g.innerHTML = '';
    
    const manualInput = document.querySelector(`#${type}-popup input`);
    if (manualInput && manualInput.value) {
        const d = document.createElement('div'); d.className = 'grid-item manual-entry'; d.style.gridColumn = "1/-1";
        d.innerHTML = `×”×•×¡×£: "${manualInput.value}" â•`;
        d.onclick = () => selectItem(type, manualInput.value);
        g.appendChild(d);
    }

    if (!items || items.length === 0) return;

    items.sort().forEach(item => {
        const d = document.createElement('div'); d.className = 'grid-item'; d.innerText = item;
        d.onclick = () => selectItem(type, item);
        g.appendChild(d);
    });
}

function selectItem(type, value) {
    document.getElementById('val-' + type.charAt(0)).value = value;
    document.getElementById(type + '-trigger').innerHTML = `<span>${value}</span> <span class="arrow">â–¼</span>`;
    document.querySelectorAll('.popup-grid').forEach(p => p.classList.remove('active'));

    // === ×œ×•×’×™×§×ª ××™×¤×•×¡ ×—×›××” ===
    if (type === 'brand') {
        resetField('model', 'ğŸï¸ ×‘×—×¨ ×“×’×...'); 
        resetField('year', 'ğŸ“… ×‘×—×¨ ×©× ×”...');
        resetField('submodel', 'âš™ï¸ ×ª×ª-×“×’×...');
        enableField('model');
    } else if (type === 'model') {
        resetField('year', 'ğŸ“… ×‘×—×¨ ×©× ×”...');
        resetField('submodel', 'âš™ï¸ ×ª×ª-×“×’×...');
        enableField('year'); 
    } else if (type === 'year') {
        resetField('submodel', 'âš™ï¸ ×ª×ª-×“×’×...');
        document.getElementById('submodel-grid').innerHTML = ''; 
        enableField('submodel'); 
    }
}

function resetField(type, ph) {
    document.getElementById('val-' + type.charAt(0)).value = '';
    const el = document.getElementById(type + '-trigger');
    el.innerHTML = `<span>${ph}</span> <span class="arrow">â–¼</span>`;
    el.classList.add('disabled');
}
function enableField(type) { document.getElementById(type + '-trigger').classList.remove('disabled'); }

window.filterGrid = function(type, query) {
    const grid = document.getElementById(type + '-grid');
    if (type !== 'submodel') {
        let source = (type === 'brand') ? Object.keys(carData) : (carData[document.getElementById('val-b').value] || []);
        renderGrid(type, source.filter(i => i.toLowerCase().includes(query.toLowerCase())));
    } else {
        Array.from(grid.querySelectorAll('.grid-item')).forEach(item => {
            item.style.display = item.innerText.toLowerCase().includes(query.toLowerCase()) ? 'flex' : 'none';
        });
    }
};

function renderYears() {
    const g = document.getElementById('year-grid'); g.innerHTML = '';
    document.getElementById('y-range-text').innerText = `${yBase}-${yBase+8}`;
    for(let i=0; i<9; i++){
        let y = yBase+i; let d = document.createElement('div'); d.className = 'grid-item'; d.innerText = y;
        d.onclick = () => selectItem('year', y);
        g.appendChild(d);
    }
}
window.shiftY = function(n) { yBase += (n * 9); renderYears(); };

window.startDeepAI = async function() {
    const b = document.getElementById('val-b').value;
    const m = document.getElementById('val-m').value;
    const s = document.getElementById('val-s').value;
    const y = document.getElementById('val-y').value;
    
    if(!b || !m || !y) return alert("×—×¡×¨×™× ×¤×¨×˜×™× ×œ× ×™×ª×•×—");
    document.getElementById('loader').style.display = 'flex';
    
    try {
        const res = await fetch('/analyze-ai', { 
            method: 'POST', 
            headers: { 'Content-Type': 'application/json' }, 
            body: JSON.stringify({ brand: b, model: `${m} ${s}`, year: y }) 
        });
        const data = await res.json();
        if(data.success && data.aiAnalysis) {
            const ai = data.aiAnalysis;
            const p = document.getElementById('ai-panel'); p.style.display = 'block';
            p.innerHTML = `<div style="background:rgba(30, 41, 59, 0.9); padding:20px; border-radius:16px; margin-top:20px; border:1px solid var(--accent);">
                <div style="font-size:48px; font-weight:900; color:var(--accent); text-align:center;">${ai.reliability_score || 'N/A'}</div>
                <p style="text-align:center; font-size:16px; margin-bottom:20px;">${ai.summary || ''}</p>
                <div style="text-align:right;">
                    <div style="color:var(--success); font-weight:bold;">âœ… ×™×ª×¨×•× ×•×ª:</div>
                    <ul style="font-size:14px; padding-right:20px; color:#cbd5e1;">${(ai.pros || []).map(p => `<li>${p}</li>`).join('')}</ul>
                    <div style="color:var(--danger); font-weight:bold; margin-top:10px;">âŒ ×ª×§×œ×•×ª:</div>
                    <ul style="font-size:14px; padding-right:20px; color:#cbd5e1;">${(ai.common_faults || []).map(c => `<li>${c}</li>`).join('')}</ul>
                </div>
                <button class="btn-main" onclick="window.goToChecklist()">×”××©×š ×œ×‘×“×™×§×” ğŸ</button>
            </div>`;
            p.scrollIntoView({ behavior: 'smooth' });
        }
    } catch(e) { 
        alert("×©×’×™××” ×‘×—×™×‘×•×¨ ×œ-AI"); 
    } finally { 
        document.getElementById('loader').style.display = 'none'; 
    }
};

window.goToChecklist = function() {
    document.getElementById('screen-input').style.display = 'none';
    document.getElementById('screen-check').style.display = 'flex';
    const content = document.getElementById('checklist-content'); content.innerHTML = '';
    currentScore = 100;
    
    checklistData.forEach((cat, cIdx) => {
        content.innerHTML += `<div class="category-header"><span class="category-title">${cat.category}</span></div>`;
        cat.items.forEach((item, iIdx) => {
            const id = `cb-${cIdx}-${iIdx}`;
            content.innerHTML += `<div class="check-item">
                <div class="check-item-header">
                    <div class="right-side">
                        <div class="info-btn" onclick="document.getElementById('how-${id}').style.display = document.getElementById('how-${id}').style.display === 'block' ? 'none' : 'block'">i</div>
                        <span class="item-name">${item.name}</span>
                    </div>
                    <div id="${id}" class="cb-custom" onclick="window.toggleCheck('${id}', ${item.weight}, '${item.name}')"></div>
                </div>
                <div id="how-${id}" class="how-to-box">${item.howTo} 
                    <span class="ok-text">${item.ok}</span>
                    <span class="not-ok-text">${item.notOk}</span>
                </div>
            </div>`;
        });
    });
    window.scrollTo(0,0);
};

window.toggleCheck = (id, weight, name) => {
    const el = document.getElementById(id);
    const isBad = el.classList.contains('bad');
    el.classList.toggle('bad');
    currentScore += isBad ? weight : -weight;
    if (!isBad) badItemsNames.push(name); else badItemsNames = badItemsNames.filter(i => i !== name);
};

window.finishCheck = () => {
    document.getElementById('screen-check').style.display = 'none';
    document.getElementById('screen-result').style.display = 'flex';
    
    const score = Math.max(0, currentScore);
    const g = document.getElementById('final-gauge');
    g.innerText = score;
    
    let color = score > 85 ? "var(--success)" : (score > 60 ? "#facc15" : "var(--danger)");
    g.style.borderColor = color; g.style.boxShadow = `0 0 30px ${color}`;
    
    let txt = "×¨×›×‘ ×‘××¦×‘ ××¢×•×œ×”!";
    if(score < 85) txt = "×™×© ×›××” ×¨×™×’'×§×˜×™×...";
    if(score < 60) txt = "×œ× ×œ×’×¢×ª ×‘×¨×›×‘!";
    
    const resText = document.getElementById('result-text');
    resText.innerText = txt;
    resText.style.color = color;

    const list = document.getElementById('defects-ul'); list.innerHTML = '';
    if (badItemsNames.length > 0) {
        document.getElementById('defects-container').style.display = 'block';
        badItemsNames.forEach(n => { const li = document.createElement('li'); li.innerText = n; list.appendChild(li); });
    } else document.getElementById('defects-container').style.display = 'none';
};

window.findGarage = () => {
    navigator.geolocation.getCurrentPosition(p => {
        window.open(`https://waze.com/ul?q=××›×•×Ÿ%20×‘×“×™×§×”&ll=${p.coords.latitude},${p.coords.longitude}&navigate=yes`, '_blank');
    }, () => window.open(`https://waze.com/ul?q=××›×•×Ÿ%20×‘×“×™×§×”&navigate=yes`, '_blank'));
};

document.addEventListener('click', (e) => { 
    if(!e.target.closest('.field-group')) document.querySelectorAll('.popup-grid').forEach(p => p.classList.remove('active')); 
});
</script>
</body>
</html>
