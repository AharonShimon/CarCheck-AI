<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <style>
        /* ×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ×›×œ×œ×™×•×ª - PRO THEME */
        :root { 
            --primary: #00F2FF; 
            --accent: #7000FF; 
            --bg: #0A0A0C; 
            --card: #16161D; 
            --text: #E0E0E0; 
            --danger: #FF3B3B; 
            --success: #00FF85; 
            --warning: #FFB800; 
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; -webkit-tap-highlight-color: transparent; }
        .container { padding: 20px; max-width: 500px; margin: auto; padding-bottom: 90px; }
        
        h1 { text-align: center; margin-bottom: 20px; font-weight: 800; letter-spacing: -1px; }
        label { display: block; margin-bottom: 6px; color: #888; font-size: 14px; font-weight: 500; }

        /* ×œ×•×—×™×ª ×¨×™×©×•×™ */
        .plate-container { background: #FFB800; padding: 5px; border-radius: 12px; border: 3px solid #000; display: flex; align-items: center; position: relative; margin-bottom: 15px; box-shadow: 0 4px 15px rgba(255, 184, 0, 0.2); }
        .plate-input { background: none; border: none; font-size: 38px; font-weight: 900; width: 100%; text-align: center; outline: none; color: #000; letter-spacing: 4px; font-family: monospace; }
        .il-tag { background: #003399; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; position: absolute; left: 8px; display: flex; flex-direction: column; align-items: center; line-height: 1; font-weight: bold; }

        /* ×©×“×•×ª ×§×œ×˜ */
        select, .ios-field { width: 100%; padding: 16px; background: var(--card); border: 1px solid #333; color: #fff; border-radius: 14px; margin-bottom: 15px; font-size: 16px; appearance: none; box-sizing: border-box; transition: 0.3s; }
        select:focus, .ios-field:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 2px rgba(0, 242, 255, 0.2); }

        /* ×›×¤×ª×•×¨×™× */
        .btn { border: none; padding: 16px; border-radius: 16px; font-size: 18px; font-weight: 700; width: 100%; cursor: pointer; transition: transform 0.1s; margin-top: 5px; }
        .btn:active { transform: scale(0.98); }
        .btn-blue { background: #007AFF; color: white; box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3); }
        .btn-ai { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; margin-top: 20px; box-shadow: 0 4px 20px rgba(0, 242, 255, 0.25); }
        .btn-finish { background: var(--success); color: #000; margin-top: 30px; box-shadow: 0 4px 15px rgba(0, 255, 133, 0.3); }

        /* ×ª×•×¦××•×ª AI */
        #ai-result { display: none; background: rgba(112, 0, 255, 0.1); border: 1px solid var(--accent); padding: 18px; border-radius: 16px; margin-top: 20px; font-size: 15px; line-height: 1.6; color: #eee; animation: fadeIn 0.5s; }

        /* ×¦'×§ ×œ×™×¡×˜ */
        .category { margin-top: 30px; color: var(--primary); font-size: 18px; font-weight: 800; border-bottom: 2px solid #222; padding-bottom: 8px; }
        .check-item { background: var(--card); padding: 15px; border-radius: 14px; margin-top: 12px; display: flex; align-items: center; justify-content: space-between; transition: 0.2s; }
        .item-left { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .cb { width: 24px; height: 24px; border: 2px solid #555; border-radius: 8px; margin-left: 15px; flex-shrink: 0; transition: 0.2s; }
        .cb.checked { background: var(--danger); border-color: var(--danger); display: flex; align-items: center; justify-content: center; }
        .cb.checked::after { content: "âœ•"; color: white; font-size: 14px; font-weight: bold; }
        
        /* ×˜×•×œ×˜×™×¤ */
        .info-btn { width: 30px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; cursor: pointer; }
        .tooltip-box { display: none; background: #222; border: 1px solid #444; padding: 12px; border-radius: 10px; font-size: 13px; color: #ccc; margin-top: 8px; line-height: 1.4; animation: fadeIn 0.3s; }

        /* ××¡×š ×¦×™×•×Ÿ */
        #score-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 25px; animation: fadeIn 0.4s; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 8px solid var(--success); display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: 900; color: var(--success); margin-bottom: 25px; box-shadow: 0 0 30px rgba(0, 255, 133, 0.2); }

        /* ×˜×¢×™× ×” */
        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loader-text" style="color:white; margin-top:20px; font-weight:bold;">×˜×•×¢×Ÿ...</p></div>

<div id="screen-input" class="container">
    <h1>CarCheck <span style="color:var(--primary)">AI PRO</span></h1>
    
    <div class="plate-container">
        <div class="il-tag"><span>IL</span><span>×™×©×¨××œ</span></div>
        <input id="plate" class="plate-input" type="tel" placeholder="12345678" maxlength="8" inputmode="numeric">
    </div>
    
    <button class="btn btn-blue" onclick="getCarDetails()">ğŸ” ××©×•×š × ×ª×•× ×™× (×¢×•×§×£ ×—×¡×™××”)</button>
    <div id="status-msg" style="text-align:center; margin: 10px 0; font-weight:bold; min-height: 20px;"></div>

    <hr style="border-color:#333; margin: 20px 0;">

    <div>
        <label>×™×¦×¨×Ÿ:</label>
        <select id="brand" onchange="updateModels()"><option value="">×‘×—×¨ ×™×¦×¨×Ÿ...</option></select>
        
        <label>×“×’×:</label>
        <select id="model" disabled><option value="">×‘×—×¨ ×™×¦×¨×Ÿ ×§×•×“×...</option></select>
        
        <label>×©× ×ª ×™×™×¦×•×¨:</label>
        <input id="year" class="ios-field" type="number" placeholder="×œ××©×œ: 2021" inputmode="numeric">
        
        <button class="btn btn-ai" onclick="analyzeAI()">ğŸ¤– × ×ª×— ×××™× ×•×ª ×•×”×ª×—×œ ×‘×“×™×§×”</button>
    </div>

    <div id="ai-result"></div>
</div>

<div id="screen-check" class="container" style="display:none">
    <h2 id="check-header" style="text-align:center; margin-bottom:5px;"></h2>
    <p style="text-align:center; color:#888; font-size:14px; margin-top:0;">×“×•×— ×‘×“×™×§×” ×“×™×’×™×˜×œ×™</p>
    
    <div id="checklist-content"></div>
    
    <button class="btn btn-finish" onclick="calculateScore()">ğŸ“Š ×¡×™×™× ×•×§×‘×œ ×¦×™×•×Ÿ ××©×•×§×œ×œ</button>
    <button class="btn" style="background:transparent; color:#666; font-size:14px;" onclick="location.reload()">×‘×™×˜×•×œ ×•×™×¦×™××”</button>
</div>

<div id="score-overlay">
    <div class="score-circle" id="final-score">0</div>
    <h2 id="score-msg" style="color:white; margin:0 0 10px 0;"></h2>
    <p id="score-desc" style="color:#aaa; max-width:300px; line-height:1.5; margin-bottom:30px;"></p>
    
    <button class="btn btn-blue" onclick="shareResult()">ğŸ“¤ ×©×ª×£ ×‘×•×•××˜×¡××¤</button>
    <button class="btn" style="background:#333; color:white; margin-top:15px;" onclick="location.reload()">×‘×“×™×§×” ×—×“×©×”</button>
</div>

<script>
// --- ××¡×“ × ×ª×•× ×™× ××•×¨×—×‘ (×”×›×™ ××§×™×£ ×©×™×©) ---
const carDatabase = {
    "×××•×“×™": ["A1", "A3", "A4", "A5", "A6", "Q2", "Q3", "Q5", "Q7", "Q8", "e-tron"],
    "××•×¤×œ": ["×§×•×¨×¡×”", "××¡×˜×¨×”", "××•×§×”", "×§×¨×•×¡×œ× ×“", "×’×¨× ×“×œ× ×“", "××™× ×¡×™×’× ×™×”"],
    "××œ×¤× ×¨×•××™××•": ["×’'×•×œ×™×™×˜×”", "×’'×•×œ×™×”", "×¡×˜×œ×‘×™×•", "×˜×•× ×œ×”", "××™×˜×•"],
    "BMW": ["×¡×“×¨×” 1", "×¡×“×¨×” 2", "×¡×“×¨×” 3", "×¡×“×¨×” 5", "X1", "X2", "X3", "X4", "X5", "X6", "i4", "iX"],
    "BYD": ["Atto 3", "Han", "Tang", "Dolphin", "Seal"],
    "×’'×™×¤": ["×¨× ×’×œ×¨", "×’×¨× ×“ ×¦'×™×¨×•×§×™", "×§×•××¤×¡", "×¨× ×’×™×™×“", "×¦'×™×¨×•×§×™"],
    "×’'×™×œ×™": ["Geometry C"],
    "×“××¦'×™×”": ["×“××¡×˜×¨", "×¡× ×“×¨×•", "×’'×•×’×¨", "×œ×•×’××Ÿ"],
    "×”×•× ×“×”": ["×¡×™×•×•×™×§", "×’'××–", "CR-V", "HR-V", "××§×•×¨×“"],
    "×•×•×œ×•×•": ["S60", "S90", "XC40", "XC60", "XC90", "C40"],
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "×™××¨×™×¡ ×§×¨×•×¡", "C-HR", "RAV4", "×œ× ×“ ×§×¨×•×–×¨", "×”×™×™×œ×§×¡", "×¤×¨×™×•×¡", "××™×™×’×•", "×§×××¨×™", "×”×™×™×œ× ×“×¨", "BZ4X"],
    "×˜×¡×œ×”": ["××•×“×œ 3", "××•×“×œ Y", "××•×“×œ S", "××•×“×œ X"],
    "×™×•× ×“××™": ["i10", "i20", "i25", "i30", "××œ× ×˜×¨×”", "××™×•× ×™×§", "××™×•× ×™×§ 5", "×˜×•×¡×•×Ÿ", "×¡× ×˜×” ×¤×”", "×§×•× ×”", "×•× ×™×•", "×¡×•× ×˜×”", "×¤×œ×™×¡×™×™×“"],
    "×œ×§×¡×•×¡": ["CT", "IS", "ES", "UX", "NX", "RX", "RZ"],
    "×××–×“×”": ["2", "3", "6", "CX-3", "CX-30", "CX-5", "CX-60", "MX-5"],
    "××™×¦×•×‘×™×©×™": ["×××•×˜×œ× ×“×¨", "ASX", "××§×œ×™×¤×¡ ×§×¨×•×¡", "×¡×¤×™×™×¡ ×¡×˜××¨", "××˜×¨××–'", "×”×× ×˜×¨"],
    "××¨×¦×“×¡": ["A-Class", "C-Class", "E-Class", "CLA", "GLA", "GLB", "GLC", "GLE", "EQA", "EQE", "EQS"],
    "× ×™×¡××Ÿ": ["××™×§×¨×”", "×’'×•×§", "×§×©×§××™", "××§×¡-×˜×¨×™×™×œ", "×¡× ×˜×¨×”", "××œ××¨×”"],
    "×¡×•×‘××¨×•": ["××™××¤×¨×–×”", "XV", "×¤×•×¨×¡×˜×¨", "×××•×˜×‘×§", "×§×¨×•×¡×˜×¨×§", "B4"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "××™×’× ×™×¡", "×•×™×˜××¨×”", "×§×¨×•×¡××•×‘×¨", "×’'×™×× ×™", "×‘××œ× ×•", "××œ×˜×•"],
    "×¡×™××˜": ["××™×‘×™×–×”", "×œ××•×Ÿ", "××¨×•× ×”", "××˜×§×”", "×˜×¨××§×•"],
    "×¡×™×˜×¨×•××Ÿ": ["C3", "C4", "C5 ××™×™×¨×§×¨×•×¡", "×‘×¨×œ×™× ×’×•", "×’'×××¤×™"],
    "×¡×§×•×“×”": ["×¤××‘×™×”", "×¨××¤×™×“", "××•×§×˜×‘×™×”", "×¡×•×¤×¨×‘", "×§×××™×§", "×§××¨×•×§", "×§×•×“×™××§", "×× ×™××§"],
    "×¤×•×œ×§×¡×•×•×’×Ÿ": ["×¤×•×œ×•", "×’×•×œ×£", "×˜×™×’×•××Ÿ", "×˜×™-×¨×•×§", "×¤××¡××˜", "×’'×˜×”", "ID.4"],
    "×¤×™×’'×•": ["208", "2008", "3008", "5008", "308", "×¤×¨×˜× ×¨"],
    "×¤×™××˜": ["500", "×˜×™×¤×•", "×¤× ×“×”", "×“×•×‘×œ×•"],
    "×§×•×¤×¨×”": ["×¤×•×¨×× ×˜×•×¨", "×œ××•×Ÿ", "××˜×§×”", "×‘×•×¨×Ÿ"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¨×™×•", "×¡×™×“", "×¤×•×¨×˜×”", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§", "×¡×•×¨× ×˜×•", "×§×¨× ×™×‘×œ", "×¡×œ×˜×•×¡", "EV6"],
    "×¨× ×•": ["×§×œ×™××•", "×§×¤×¦'×•×¨", "××’××Ÿ", "××¨×§× ×”", "×§× ×’×•", "×’×¨× ×“ ×§×•×¤×”"],
    "×©×‘×¨×•×œ×˜": ["×¡×¤××¨×§", "×˜×¨××§×¡", "××§×•×•×™× ×•×§×¡", "×˜×¨××•×•×¨×¡", "×¡×™×œ×‘×¨×“×•", "×××œ×™×‘×•"]
};

const checklistData = {
    "×× ×•×¢ ×•× ×•×–×œ×™×": [
        { name: "××¤×œ×¡ ×©××Ÿ ×•×¦×‘×¢", tip: "×”×•×¦× ××“×™×“. ×•×•×“× ×©×”×©××Ÿ ×‘×™×Ÿ ×”×§×•×•×™×. ×¦×‘×¢ ×©×—×•×¨/×—×•× ×–×” ×ª×§×™×Ÿ. ×¦×‘×¢ ××¤×•×¨ ('×˜×—×™× ×”') = ×¡×›× ×”!" },
        { name: "× ×•×–×œ ×§×™×¨×•×¨", tip: "×‘×“×•×§ ×‘××™×›×œ ×”×¢×•×“×¤×™× (×œ× ×œ×¤×ª×•×— ×¨×“×™××˜×•×¨ ×—×!). ×”××™× ×¦×¨×™×›×™× ×œ×”×™×•×ª ×‘×¦×‘×¢ ×™×™×¢×•×“×™ (×™×¨×•×§/×•×¨×•×“) ×•×œ× ×—×•××™×." },
        { name: "× ×–×™×œ×•×ª (×©××Ÿ/××™×)", tip: "×”×‘×˜ ××ª×—×ª ×œ×¨×›×‘ ×•××¡×‘×™×‘ ×œ×× ×•×¢. ×”×× ×™×© ×¨×˜×™×‘×•×ª ×˜×¨×™×™×”?" },
        { name: "×¨×¢×© ×× ×•×¢", tip: "×”×§×©×‘ ×œ×× ×•×¢ ×‘×¡×¨×§. ×”×× ×™×© ×ª×§×ª×•×§×™× ××ª×›×ª×™×™× ××• ×¨×¢×© ×œ× ××—×™×“?" },
        { name: "×¢×©×Ÿ ××”××’×–×•×–", tip: "×¢×©×Ÿ ×œ×‘×Ÿ ×¡××™×š = ××™× ×‘×× ×•×¢. ×¢×©×Ÿ ×›×—×•×œ = ×©××Ÿ × ×©×¨×£." }
    ],
    "×’×™×¨ ×•×”× ×¢×”": [
        { name: "×©×™×œ×•×‘ ×”×™×œ×•×›×™×", tip: "×”×¢×‘×¨ ×‘×™×Ÿ P, R, N, D. ×”×× ×™×© ××›×” ×—×–×§×” ××• ×”×©×”×™×™×” ××¨×•×›×”? (×œ× ×ª×§×™×Ÿ)" },
        { name: "×”×—×œ×§×” ×‘× ×¡×™×¢×”", tip: "×‘×–××Ÿ ×”××¦×”, ×”×× ×”×˜×•×¨×™× ×¢×•×œ×™× ××‘×œ ×”×¨×›×‘ ×œ× ×××™×¥ ×‘×”×ª××?" },
        { name: "×¦×™×¨×™×•×ª", tip: "×‘×¦×¢ ×¡×™×‘×•×‘ ×¤×¨×¡×” ××œ×. ×”×× ×™×© ×¨×¢×© ×©×œ × ×§×™×©×•×ª ('×§×œ×™×§ ×§×œ×™×§') ××”×’×œ×’×œ×™×?" }
    ],
    "××¨×›×‘ ×•×©×œ×“×”": [
        { name: "×”×¤×¨×©×™ ×’×•×•×Ÿ ×¦×‘×¢", tip: "×”×¡×ª×›×œ ×¢×œ ×”×¨×›×‘ ×‘×©××©. ×”×× ×“×œ×ª ××—×ª × ×¨××™×ª ×›×”×” ×™×•×ª×¨ ××”×©× ×™×™×”? (×¡×™××Ÿ ×œ×ª××•× ×”)" },
        { name: "×§×•×¨×•×ª ×©×œ×“×” (×ª× ×× ×•×¢)", tip: "×¤×ª×— ××›×¡×” ×× ×•×¢. ×—×¤×© ×¡×™×× ×™ ××¢×™×›×”, ×¨×™×ª×•×›×™× ×’×¡×™× ××• ×¦×‘×¢ ×—×“×© ×¢×œ ×”×‘×¨×–×œ×™× ×‘×¦×“×“×™×." },
        { name: "×¨×•×•×—×™× (Panel Gaps)", tip: "×”×× ×”×¨×•×•×— ×‘×™×Ÿ ××›×¡×” ×”×× ×•×¢ ×œ×›× ×¤×™×™× ×©×•×•×” ×‘×©× ×™ ×”×¦×“×“×™×?" },
        { name: "×¦××™×’×™×", tip: "×‘×“×•×§ 4 ×¡×¤×¨×•×ª ×¢×œ ×”×¦××™×’ (×œ××©×œ 2021). ×¦××™×’ ××¢×œ 4 ×©× ×™× ×¤×¡×•×œ." }
    ],
    "×—×©××œ ×•×¤× ×™×": [
        { name: "××–×’×Ÿ (×§×•×¨ ××§×¡×™××œ×™)", tip: "×”×× ×™×•×¦× ××•×•×™×¨ ×§×¤×•× ×ª×•×š ×“×§×”? ×”×× ×”××“×—×¡ × ×›× ×¡ ×œ×¤×¢×•×œ×”?" },
        { name: "×—×™××•×", tip: "×”×¢×‘×¨ ×œ×—×•×. ×”×× ×™×•×¦× ××•×•×™×¨ ×—×? (×—×©×•×‘ ×‘×—×•×¨×£ ×•×’× ××¢×™×“ ×¢×œ ××¢×¨×›×ª ×§×™×¨×•×¨ ×ª×§×™× ×”)" },
        { name: "× ×•×¨×•×ª ××–×”×¨×”", tip: "×¤×ª×— ×¡×•×•×™×¥'. ×•×•×“× ×©×›×œ ×”× ×•×¨×•×ª × ×“×œ×§×•×ª. ×”× ×¢. ×•×•×“× ×©×›×•×œ×Ÿ × ×›×‘×•×ª (×‘××™×•×—×“ ×× ×•×¢ ×•×›×¨×™×•×ª ××•×•×™×¨)." },
        { name: "×—×œ×•× ×•×ª ×•× ×¢×™×œ×”", tip: "×‘×“×•×§ ×©×›×œ 4 ×”×—×œ×•× ×•×ª ×™×•×¨×“×™× ×•×¢×•×œ×™×, ×•×”× ×¢×™×œ×” ×”××¨×›×–×™×ª ×¢×•×‘×“×ª." }
    ]
};

// --- ×œ×•×’×™×§×” ---

// 1. ××ª×—×•×œ ×¨×©×™××ª ×™×¦×¨× ×™×
const brandSel = document.getElementById('brand');
Object.keys(carDatabase).sort().forEach(b => {
    brandSel.innerHTML += `<option value="${b}">${b}</option>`;
});

function updateModels() {
    const b = brandSel.value;
    const mSel = document.getElementById('model');
    mSel.innerHTML = '<option value="">×‘×—×¨ ×“×’×...</option>';
    
    if (b && carDatabase[b]) {
        mSel.disabled = false;
        carDatabase[b].forEach(m => mSel.innerHTML += `<option value="${m}">${m}</option>`);
    } else {
        mSel.disabled = true;
    }
}

// 2. ××©×™×›×ª × ×ª×•× ×™× (×¢× ××¢×§×£ ×—×¡×™××•×ª)
async function getCarDetails() {
    let p = document.getElementById('plate').value.replace(/\D/g,'');
    if (p.length < 7) { 
        setStatus("××¡×¤×¨ ×œ×•×—×™×ª ×—×™×™×‘ ×œ×”×™×•×ª 7-8 ×¡×¤×¨×•×ª", "warning"); 
        return; 
    }
    
    showLoader("××ª×—×‘×¨ ×œ×××’×¨ ××©×¨×“ ×”×ª×—×‘×•×¨×”...");
    setStatus("", "");

    try {
        // × ×™×¡×™×•×Ÿ ×¨××©×•×Ÿ: ×™×©×™×¨×•×ª ××”×“×¤×“×¤×Ÿ (Client Side)
        const govUrl = `https://data.gov.il/api/3/action/datastore_search?resource_id=053ad243-5e8b-4334-8397-47883b740881&q=${p}`;
        const res = await fetch(govUrl);
        const data = await res.json();
        
        if (data.result && data.result.records.length > 0) {
            fillData(data.result.records[0]);
        } else {
            // × ×™×¡×™×•×Ÿ ×©× ×™: ×“×¨×š ×”×©×¨×ª (Proxy)
            console.log("Client fetch empty, trying server...");
            const srvRes = await fetch('/get-car-details', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ plate: p })
            });
            const srvData = await srvRes.json();
            
            if (srvData.success) {
                fillData(srvData.data);
            } else {
                setStatus("×”×¨×›×‘ ×œ× × ××¦× ×‘×××’×¨. × × ×œ××œ× ×™×“× ×™×ª.", "warning");
            }
        }
    } catch(e) {
        console.error(e);
        setStatus("×ª×§×œ×” ×‘×ª×§×©×•×¨×ª ×œ×××’×¨. × × ×œ××œ× ×™×“× ×™×ª.", "danger");
    } finally {
        hideLoader();
    }
}

function fillData(c) {
    // ×©× ×”
    document.getElementById('year').value = c.shnat_yitzur || c.SHNAT_YITZUR || "";
    
    // × ×™×¡×™×•×Ÿ ×”×ª×××ª ×™×¦×¨×Ÿ
    const govBrand = (c.tozeret_nm || c.TOZERET_NM || "").trim();
    let found = false;
    
    for (let opt of brandSel.options) {
        // ×‘×“×™×§×” ×× ×”×©× ××”×××©×œ×” ××›×™×œ ××ª ×©× ×”×™×¦×¨×Ÿ ×©×œ× ×• (×œ××©×œ "×˜×•×™×•×˜×” ×˜×•×¨×§×™×”" ×™×ª×¤×•×¡ "×˜×•×™×•×˜×”")
        if (govBrand.includes(opt.value) && opt.value !== "") {
            brandSel.value = opt.value;
            updateModels();
            found = true;
            break;
        }
    }
    
    if (found) {
        setStatus("âœ… ×¨×›×‘ ×–×•×”×” ×‘×”×¦×œ×—×”!", "success");
    } else {
        setStatus(`×–×•×”×”: ${govBrand}. ×× × ×‘×—×¨ ×™×¦×¨×Ÿ ××”×¨×©×™××”.`, "warning");
    }
}

// 3. ×‘×™× ×” ××œ××›×•×ª×™×ª
async function analyzeAI() {
    const b = brandSel.value;
    const m = document.getElementById('model').value;
    const y = document.getElementById('year').value;
    
    if (!b || !m) return alert("×—×•×‘×” ×œ×‘×—×•×¨ ×™×¦×¨×Ÿ ×•×“×’×!");
    
    showLoader("×”-AI ×× ×ª×— × ×ª×•× ×™ ×××™× ×•×ª...");
    
    try {
        const res = await fetch('/analyze-ai', {
            method: 'POST', headers: {'Content-Type':'application/json'},
            body: JSON.stringify({ brand: b, model: m, year: y })
        });
        const data = await res.json();
        
        const resDiv = document.getElementById('ai-result');
        resDiv.style.display = 'block';
        
        if (data.success) {
            resDiv.innerHTML = `<strong>ğŸ¤– ×“×•×— AI:</strong><br>${data.aiAnalysis.replace(/\n/g, '<br>')}`;
            // ×’×œ×™×œ×” ×œ×ª×•×¦××”
            resDiv.scrollIntoView({behavior: "smooth"});
        } else {
            if (data.error === "TOO_MANY_REQUESTS") {
                resDiv.innerHTML = "<span style='color:var(--warning)'>âš ï¸ ×”××¢×¨×›×ª ×‘×¢×•××¡. ×”××ª×Ÿ ×“×§×” ×•× ×¡×” ×©×•×‘.</span>";
            } else {
                resDiv.innerHTML = "<span style='color:var(--danger)'>âŒ ×©×’×™××” ×‘×§×‘×œ×ª × ×ª×•× ×™×. ×”××©×š ×œ×‘×“×™×§×” ×™×“× ×™×ª.</span>";
            }
        }
    } catch(e) {
        alert("×©×’×™××ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª");
    } finally {
        hideLoader();
        // ×”×•×¡×¤× ×• ×›×¤×ª×•×¨ ××¢×‘×¨ ×™×“× ×™ ×‘××™×“×” ×•×”-AI × ×›×©×œ, ××‘×œ ×”××©×ª××© ×™×›×•×œ ×’× ×¤×©×•×˜ ×œ×’×œ×•×œ
        setTimeout(() => {
             // ××•×¤×¦×™×•× ×œ×™: ××¢×‘×¨ ××•×˜×•××˜×™ ×× ×¨×•×¦×™×
        }, 1000);
    }
}

// 4. ××¡×š ×‘×“×™×§×”
function goToInspection() {
    // ×‘×“×™×§×” ×©×™×© × ×ª×•× ×™×
    if (!brandSel.value) return alert("×‘×—×¨ ×¨×›×‘ ×§×•×“×");

    document.getElementById('screen-input').style.display = 'none';
    document.getElementById('screen-check').style.display = 'block';
    
    // ×›×•×ª×¨×ª
    document.getElementById('check-header').innerText = `${brandSel.value} ${document.getElementById('model').value} (${document.getElementById('year').value})`;
    
    renderChecklist();
    window.scrollTo(0,0);
}

// ×”×•×¡×¤×ª×™ ××™×¨×•×¢ ×œ×—×™×¦×” ×œ×›×¤×ª×•×¨ ×”-AI ×©×™×¢×‘×™×¨ ×‘×¡×•×£ (×”××©×ª××© ×™×›×•×œ ×œ×§×¨×•× ×•××– ×œ×¢×‘×•×¨)
// ×¢×“×›×•×Ÿ: ×¢×“×™×£ ×œ×”×¢×‘×™×¨ ××ª goToInspection ×œ×›×¤×ª×•×¨ × ×¤×¨×“ ××• ××•×˜×•××˜×™×ª?
// ×‘×’×¨×¡×” ×”×–×• ×”××©×ª××© ×œ×•×—×¥ ×¢×œ "×”×ª×—×œ ×‘×“×™×§×”" ××—×¨×™ ×”-AI, ××• ×©×”-AI ×”×•× ×¨×§ ××™×“×¢.
// ×©×™× ×™×ª×™ ××ª ×›×¤×ª×•×¨ ×”-AI ×©×¨×§ ×™×¦×™×’ ××™×“×¢. ××ª ×”××¢×‘×¨ × ×¢×©×” ×›×¤×ª×•×¨ × ×¤×¨×“? 
// ×œ×, ×‘×•× × ×¢×©×” ×©×”×›×¤×ª×•×¨ "× ×ª×—" ×’× ×™×¦×™×’ ××™×“×¢ ×•×’× ×™×—×©×•×£ ×›×¤×ª×•×¨ "×”××©×š".
// ×œ×˜×•×‘×ª ×”×¤×©×˜×•×ª ×‘×§×•×“ ×”×–×”: ×”××¢×‘×¨ ×”×•× ×—×œ×§ ××”×–×¨×™××”. ×‘×•× × ×•×¡×™×£ ×›×¤×ª×•×¨ "×”××©×š ×œ×¦'×§ ×œ×™×¡×˜" ×©×™×•×¤×™×¢ ××—×¨×™ ×”× ×™×ª×•×—.
// ×ª×™×§×•×Ÿ ××”×™×¨: ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ××¢×‘×¨ ×“×™× ××™
function showContinueBtn() {
    // ×× ×›×‘×¨ ×§×™×™× ×œ× ×œ×”×•×¡×™×£
    if(document.getElementById('btn-cont')) return;
    const btn = document.createElement('button');
    btn.id = 'btn-cont';
    btn.className = 'btn btn-blue';
    btn.style.marginTop = '15px';
    btn.innerText = '×”××©×š ×œ×¦\'×§ ×œ×™×¡×˜ ×‘×“×™×§×” â”';
    btn.onclick = goToInspection;
    document.getElementById('screen-input').appendChild(btn);
}
// × ×—×‘×¨ ××ª ×–×” ×œ×¤×•× ×§×¦×™×™×ª analyzeAI ×‘×”×¦×œ×—×”:
// (×”×•×¡×¤×ª×™ ××ª ×”×§×¨×™××” ×‘×ª×•×š ×”-Script ×œ××¢×œ×”, ××‘×œ ×”× ×” ×”×ª×™×§×•×Ÿ ×œ×§×•×“ ×”×§×™×™× ×‘×œ×•×§ analyzeAI)
// ×‘×ª×•×š ×”-success ×©×œ analyzeAI ×ª×•×¡×™×£: showContinueBtn();

// 5. ×¨× ×“×•×¨ ×”×¦'×§ ×œ×™×¡×˜
function renderChecklist() {
    let html = "";
    let id = 0;
    
    // ×”×•×¡×¤×ª ×¡×™×›×•× AI ×× ×§×™×™×
    const aiText = document.getElementById('ai-result').innerText;
    if (aiText && aiText.length > 10) {
        html += `<div style="background:rgba(0,242,255,0.1); border:1px solid var(--primary); padding:15px; border-radius:12px; margin-bottom:20px; font-size:14px;">${aiText}</div>`;
    }

    for (let cat in checklistData) {
        html += `<div class="category">${cat}</div>`;
        checklistData[cat].forEach(item => {
            id++;
            html += `
                <div class="check-item">
                    <div class="item-left" onclick="toggleCB(${id})">
                        <div class="cb" id="cb_${id}"></div>
                        <span style="font-weight:500;">${item.name}</span>
                    </div>
                    <div class="info-btn" onclick="toggleTip(${id})">?</div>
                </div>
                <div class="tooltip-box" id="tip_${id}">${item.tip}</div>
            `;
        });
    }
    document.getElementById('checklist-content').innerHTML = html;
}

function toggleCB(id) { document.getElementById('cb_'+id).classList.toggle('checked'); }
function toggleTip(id) { 
    const el = document.getElementById('tip_'+id);
    el.style.display = (el.style.display === 'block') ? 'none' : 'block';
}

// 6. ×—×™×©×•×‘ ×¦×™×•×Ÿ
function calculateScore() {
    const total = document.querySelectorAll('.cb').length;
    const checked = document.querySelectorAll('.cb.checked').length;
    
    // ×—×™×©×•×‘: ×›×œ ×ª×§×œ×” ××•×¨×™×“×” ×™×—×¡×™×ª
    // × × ×™×— 16 ×¡×¢×™×¤×™×. ×›×œ ×¡×¢×™×£ = 6.25 × ×§×•×“×•×ª.
    let score = Math.round(100 - ((checked / total) * 100));
    if (score < 0) score = 0;
    
    const circle = document.getElementById('final-score');
    const msg = document.getElementById('score-msg');
    const desc = document.getElementById('score-desc');
    
    circle.innerText = score;
    
    // ×œ×•×’×™×§×ª ×¦×‘×¢×™× ×•×˜×§×¡×˜
    if (score >= 85) {
        circle.style.borderColor = "var(--success)";
        circle.style.color = "var(--success)";
        msg.innerText = "×¨×›×‘ ××•××œ×¥! âœ…";
        desc.innerText = "×”×¨×›×‘ ×‘××¦×‘ ××›× ×™ ×•×§×•×¡××˜×™ ×˜×•×‘ ×××•×“. ×”×œ×™×§×•×™×™× ×©× ××¦××• (×× ×‘×›×œ×œ) ×”× ×©×•×œ×™×™×.";
    } else if (score >= 60) {
        circle.style.borderColor = "var(--warning)";
        circle.style.color = "var(--warning)";
        msg.innerText = "×“×•×¨×© ×‘×“×™×§×” ×‘××•×¡×š âš ï¸";
        desc.innerText = "× ××¦××• ××¡×¤×¨ ×œ×™×§×•×™×™×. ×™×© ×œ×§×—×ª ×œ×‘×“×™×§×” ××§×¦×•×¢×™×ª ×‘××•×¡×š ×œ×¤× ×™ ×§× ×™×” ×›×“×™ ×œ×§×‘×œ ×”×¦×¢×ª ××—×™×¨ ×œ×ª×™×§×•×Ÿ.";
    } else {
        circle.style.borderColor = "var(--danger)";
        circle.style.color = "var(--danger)";
        msg.innerText = "×œ× ××•××œ×¥ ×œ×§× ×™×™×” âŒ";
        desc.innerText = "×”×¨×›×‘ ×‘××¦×‘ ×™×¨×•×“ ×¢× ×ª×§×œ×•×ª ××”×•×ª×™×•×ª. ×¢×œ×•×™×•×ª ×”×ª×™×§×•×Ÿ ×¦×¤×•×™×•×ª ×œ×”×™×•×ª ×’×‘×•×”×•×ª.";
    }
    
    document.getElementById('score-overlay').style.display = 'flex';
}

function shareResult() {
    const carName = document.getElementById('check-header').innerText;
    const score = document.getElementById('final-score').innerText;
    const msg = document.getElementById('score-msg').innerText;
    const text = `*×‘×“×™×§×ª ×¨×›×‘ - ${carName}* \n×¦×™×•×Ÿ ×¡×•×¤×™: *${score}* \n×¡×˜×˜×•×¡: ${msg} \n\n× ×‘×“×§ ×‘-CarCheck AI Pro`;
    window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
}

// ×¢×–×¨×™×
function showLoader(txt) { document.getElementById('loader-text').innerText = txt; document.getElementById('loader').style.display = 'flex'; }
function hideLoader() { document.getElementById('loader').style.display = 'none'; }
function setStatus(txt, type) {
    const el = document.getElementById('status-msg');
    el.innerText = txt;
    el.style.color = type === 'success' ? 'var(--success)' : (type === 'danger' ? 'var(--danger)' : 'var(--warning)');
}

// ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”××©×š ××—×¨×™ AI (×ª×™×§×•×Ÿ ×œ×–×¨×™××”)
const originalAnalyzeAI = analyzeAI;
analyzeAI = async function() {
    await originalAnalyzeAI(); // ×”×¨×¦×ª ×”××§×•×¨
    // ×× ×™×© ×ª×•×¦××”, × ×•×¡×™×£ ×›×¤×ª×•×¨
    if (document.getElementById('ai-result').style.display === 'block') {
        showContinueBtn();
    }
}
</script>
</body>
</html>
