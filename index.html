<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root { --bg-deep:#0f172a; --bg-gradient-start:#0f172a; --bg-gradient-end:#1e293b; --card-bg:rgba(30,41,59,0.85); --card-border:rgba(148,163,184,0.15); --accent:#38bdf8; --accent-glow:rgba(56,189,248,0.3); --text-main:#f8fafc; --text-muted:#94a3b8; --danger:#ef4444; --success:#10b981; --plate-yellow:#facc15; }
        body { font-family: 'Heebo', sans-serif; background: linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%); color: var(--text-main); margin: 0; direction: rtl; min-height: 100vh; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; -webkit-tap-highlight-color: transparent; }
        .container { padding: 24px; width: 100%; max-width: 480px; box-sizing: border-box; padding-bottom: 120px; }
        header { text-align: center; margin: 20px 0 30px 0; }
        header h1 { font-size: 28px; font-weight: 900; letter-spacing: 1px; margin: 0; text-transform: uppercase; background: linear-gradient(to right, #fff, #94a3b8); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        header h1 span { background: linear-gradient(to right, var(--accent), #60a5fa); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 20px var(--accent-glow); }
        
        /* ×œ×•×—×™×ª ×¨×™×©×•×™ */
        .plate-box { background: var(--plate-yellow); padding: 4px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); margin: 0 auto 30px auto; width: 100%; max-width: 320px; position: relative; }
        .plate-inner { border: 3px solid #1e293b; border-radius: 8px; display: flex; align-items: center; padding: 0 10px; height: 60px; background: var(--plate-yellow); }
        .plate-inner::before { content: "IL"; display: flex; align-items: center; justify-content: center; color: white; font-weight: bold; font-size: 10px; width: 25px; height: 100%; background: #003399; border-radius: 4px 0 0 4px; margin-left: 10px; }
        .plate-input { background: none; border: none; font-size: 38px; font-weight: 800; width: 100%; text-align: center; outline: none; letter-spacing: 4px; font-family: monospace; color: #1e293b; height: 100%; padding-top: 5px; }

        /* ×‘×—×™×¨×” */
        .field-group { margin-bottom: 20px; width: 100%; position: relative; }
        label { font-size: 14px; font-weight: 600; color: var(--accent); margin-bottom: 8px; display: block; padding-right: 5px; opacity: 0.9; }
        .selector-trigger { width: 100%; height: 64px; background: var(--card-bg); backdrop-filter: blur(12px); border: 1px solid var(--card-border); border-radius: 16px; color: #fff; font-size: 17px; font-weight: 500; cursor: pointer; display: flex; justify-content: space-between; align-items: center; padding: 0 20px; box-sizing: border-box; transition: all 0.2s ease; }
        .selector-trigger.disabled { opacity: 0.4; pointer-events: none; }
        
        .popup-grid { display: none; position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid var(--accent); border-radius: 16px; padding: 12px; z-index: 9999; margin-top: 8px; box-shadow: 0 20px 50px rgba(0,0,0,0.6); max-height: 380px; overflow-y: auto; }
        .popup-grid.active { display: block; animation: slideUp 0.2s ease-out; }
        .search-input { width: 100%; padding: 14px; margin-bottom: 12px; background: #0f172a; border: 1px solid var(--card-border); border-radius: 10px; color: white; font-size: 16px; box-sizing: border-box; outline: none; text-align: right; }
        .grid-layout { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
        .grid-item { padding: 12px 4px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 10px; font-size: 14px; cursor: pointer; color: var(--text-muted); min-height: 48px; display: flex; align-items: center; justify-content: center; }
        .grid-item:hover { background: var(--accent); color: #000; font-weight: 700; }

        /* ×›×¤×ª×•×¨×™× */
        .btn-main { width: 100%; padding: 18px; border-radius: 16px; border: none; font-size: 17px; font-weight: 700; cursor: pointer; color: white; background: linear-gradient(135deg, #38bdf8 0%, #2563eb 100%); margin-top: 20px; display: flex; align-items: center; justify-content: center; gap: 10px; }
        .btn-main:disabled { filter: grayscale(1); opacity: 0.6; cursor: not-allowed; }
        .btn-outline { background: rgba(255,255,255,0.03); border: 1px solid var(--card-border); margin-top: 15px; color: var(--text-muted); }

        /* ×¦'×§×œ×™×¡×˜ */
        #screen-check { display: none; width: 100%; flex-direction: column; align-items: center; }
        .category-header { width: 100%; margin: 30px 0 15px 0; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); text-align: right; }
        .category-title { color: var(--accent); font-size: 19px; font-weight: 800; }
        .check-item { width: 100%; background: var(--card-bg); border-radius: 16px; margin-bottom: 14px; border: 1px solid var(--card-border); overflow: hidden; }
        .check-item-header { display: flex; justify-content: space-between; align-items: center; padding: 18px; }
        .item-info { display: flex; align-items: center; gap: 12px; }
        .info-btn { width: 28px; height: 28px; border-radius: 50%; background: rgba(56, 189, 248, 0.1); color: var(--accent); display: flex; align-items: center; justify-content: center; font-style: italic; font-weight: bold; border: 1px solid var(--accent); cursor: pointer; }
        .cb-custom { width: 32px; height: 32px; border: 2px solid #475569; border-radius: 8px; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .cb-custom.bad { background: var(--danger); border-color: var(--danger); }
        .cb-custom.bad:after { content: 'âœ•'; color: white; font-weight: bold; font-size: 20px; }
        
        .how-to-box { display: none; background: rgba(15, 23, 42, 0.6); padding: 15px; font-size: 14px; color: var(--text-muted); line-height: 1.6; border-top: 1px solid var(--card-border); }
        .status-tag { display: block; margin-top: 8px; font-weight: 700; padding: 6px 10px; border-radius: 6px; font-size: 13px; }
        .status-ok { color: var(--success); background: rgba(16, 185, 129, 0.1); border-right: 3px solid var(--success); }
        .status-not-ok { color: var(--danger); background: rgba(239, 68, 68, 0.1); border-right: 3px solid var(--danger); }

        /* ×ª×•×¦××” ×¡×•×¤×™×ª */
        #screen-result { display: none; flex-direction: column; align-items: center; width: 100%; }
        .final-gauge { width: 160px; height: 160px; border-radius: 50%; border: 10px solid var(--card-border); display: flex; align-items: center; justify-content: center; font-size: 56px; font-weight: 900; margin: 30px 0; background: var(--card-bg); }

        /* ×œ×•××“×¨ */
        #loader { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.9); z-index: 10000; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--accent); border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><div style="margin-top:20px; color:var(--accent);">ğŸ¤– AI ×× ×ª×— × ×ª×•× ×™×...</div></div>

<div id="screen-input" class="container">
    <header><h1>ğŸš— CarCheck <span>PRO</span></h1></header>
    
    <div class="plate-box">
        <div class="plate-inner">
            <input id="plate" class="plate-input" type="tel" placeholder="00-000-00" maxlength="8">
        </div>
    </div>

    <div class="field-group">
        <label>×™×¦×¨×Ÿ</label>
        <div id="brand-trigger" class="selector-trigger" onclick="openPicker('brand')"><span>×‘×—×¨ ×™×¦×¨×Ÿ...</span> <span>â–¼</span></div>
        <div id="brand-popup" class="popup-grid">
            <input type="text" class="search-input" placeholder="×—×¤×© ×™×¦×¨×Ÿ..." onkeyup="filterGrid('brand', this.value)">
            <div id="brand-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-b">
    </div>

    <div class="field-group">
        <label>×“×’×</label>
        <div id="model-trigger" class="selector-trigger disabled" onclick="openPicker('model')"><span>×‘×—×¨ ×“×’×...</span> <span>â–¼</span></div>
        <div id="model-popup" class="popup-grid">
            <input type="text" class="search-input" placeholder="×—×¤×© ×“×’×..." onkeyup="filterGrid('model', this.value)">
            <div id="model-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-m">
    </div>

    <div class="field-group">
        <label>×©× ×”</label>
        <div id="year-trigger" class="selector-trigger disabled" onclick="openPicker('year')"><span>×‘×—×¨ ×©× ×”...</span> <span>â–¼</span></div>
        <div id="year-popup" class="popup-grid">
            <div id="year-grid" class="grid-layout"></div>
        </div>
        <input type="hidden" id="val-y">
    </div>

    <button id="btn-ai" class="btn-main" onclick="startAI()">ğŸš€ × ×™×ª×•×— AI ×¢××•×§</button>
    <button class="btn-main btn-outline" onclick="goToChecklist()">ğŸ“‹ ×“×œ×’ ×œ×‘×“×™×§×ª ×©×˜×—</button>
    
    <div id="ai-result-box" style="display:none; margin-top:25px;"></div>
</div>

<div id="screen-check" class="container">
    <header><h1>ğŸ“‹ ×‘×“×™×§×ª <span>×©×˜×—</span></h1></header>
    <div id="checklist-content"></div>
    <div style="position:fixed; bottom:0; left:0; right:0; padding:20px; background:var(--bg-deep); border-top:1px solid var(--card-border);">
        <button class="btn-main" style="background:var(--success)" onclick="finishCheck()">ğŸ“Š ×¡×™×™× ×•×—×©×‘ ×ª×•×¦××”</button>
    </div>
</div>

<div id="screen-result" class="container">
    <header><h1>ğŸ† ×¡×™×›×•× <span>×‘×“×™×§×”</span></h1></header>
    <div id="final-gauge" class="final-gauge">0</div>
    <h2 id="result-status" style="text-align:center;"></h2>
    <div id="defects-box" style="background:rgba(239,68,68,0.1); padding:20px; border-radius:16px; border:1px solid var(--danger); display:none;">
        <h3 style="color:var(--danger); margin-top:0;">âš ï¸ ×œ×™×§×•×™×™× ×©× ××¦××•:</h3>
        <ul id="defects-list" style="margin:0; padding-right:20px;"></ul>
    </div>
    <button class="btn-main" style="margin-top:30px;" onclick="location.reload()">ğŸ”„ ×‘×“×™×§×” ×—×“×©×”</button>
</div>

<script>
// --- × ×ª×•× ×™× ---
const carData = {
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "RAV4", "×œ× ×“ ×§×¨×•×–×¨", "C-HR", "×¤×¨×™×•×¡"],
    "×™×•× ×“××™": ["i10", "i20", "×˜×•×¡×•×Ÿ", "××™×•× ×™×§ 5", "××œ× ×˜×¨×”", "×§×•× ×”"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§", "×¡×œ×˜×•×¡"],
    "×××–×“×”": ["2", "3", "CX-5", "CX-30", "6"],
    "×¡×§×•×“×”": ["××•×§×˜×‘×™×”", "×§×•×“×™××§", "×¡×•×¤×¨×‘", "×§×××™×§", "×¤××‘×™×”"],
    "×˜×¡×œ×”": ["Model 3", "Model Y", "Model S"],
    "BYD": ["Atto 3", "Dolphin", "Seal"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "×•×™×˜××¨×”", "×’'×™×× ×™", "×§×¨×•×¡××•×‘×¨"]
};

const checklistData = [
    { 
        category: "ğŸ”© ×× ×•×¢ ×•×ª× ×× ×•×¢", 
        items: [
            { name: "ğŸ›¢ï¸ ×¤×§×§ ×©××Ÿ (×˜×—×™× ×”)", weight: 25, howTo: "×¤×ª×—×• ×¤×§×§ ×©××Ÿ. ×—×¤×©×• ×§×¦×£ ×œ×‘×Ÿ ×“××•×™ ×—×•××•×¡.", ok: "× ×§×™/×©××Ÿ ×¨×’×™×œ", notOk: "×™×© ×§×¦×£ ×œ×‘×Ÿ (×—×©×“ ×œ×¨××© ×× ×•×¢)" },
            { name: "ğŸ«§ ×‘×•×¢×•×ª ×‘××™×›×œ ×¢×™×‘×•×™", weight: 25, howTo: "×× ×•×¢ ×¢×•×‘×“. ×”×× ×™×© ×‘×•×¢×•×ª ××•×•×™×¨ ×‘××™×?", ok: "× ×•×–×œ ×©×§×˜", notOk: "×™×© ×‘×•×¢×•×ª (×‘×¨×™×—×ª ×§×•××¤×¨×¡×™×”)" },
            { name: "ğŸŒ¬ï¸ × ×©×™××ª ×× ×•×¢", weight: 20, howTo: "×¤×ª×—×• ×¤×§×§ ×©××Ÿ ×‘×–××Ÿ ×¢×‘×•×“×”. ×”×× ×™×•×¦× ×œ×—×¥ ×—×–×§?", ok: "×œ×—×¥ ×—×œ×©/×ª×§×™×Ÿ", notOk: "×œ×—×¥ ×—×–×§ ××• ×¢×©×Ÿ ×¡××™×š" },
            { name: "ğŸ’§ × ×–×™×œ×•×ª ×˜×¨×™×•×ª", weight: 15, howTo: "×—×¤×©×• ×¨×˜×™×‘×•×ª ×©××Ÿ ××• ××™× ×¡×‘×™×‘ ×”×× ×•×¢.", ok: "×”×›×œ ×™×‘×©", notOk: "×™×© ×¡×™×× ×™ × ×–×™×œ×” ×‘×¨×•×¨×™×" }
        ] 
    },
    { 
        category: "âš™ï¸ ×’×™×¨ ×•××¢×¨×›×ª ×”× ×¢×”", 
        items: [
            { name: "ğŸ¥Š ××›×•×ª ×‘×©×™×œ×•×‘", weight: 20, howTo: "×”×¢×‘×™×¨×• ×‘×™×Ÿ P ×œ-D. ×”×× ×™×© ××›×” ×—×–×§×”?", ok: "××¢×‘×¨ ×—×œ×§", notOk: "×™×© '×‘×•×' ××• ×§×¤×™×¦×” ×—×–×§×”" },
            { name: "â›¸ï¸ ×”×—×œ×§×ª ×”×™×œ×•×›×™×", weight: 20, howTo: "×‘× ×¡×™×¢×” - ×’×– ×—×–×§. ×”×× ×”×˜×•×¨×™× ×§×•×¤×¦×™× ×œ×œ× ×”××¦×”?", ok: "×××™×¥ ×¨×¦×™×£", notOk: "×”×˜×•×¨×™× ×¢×•×œ×™× ×•×”×¨×›×‘ ×œ× ×–×–" }
        ] 
    },
    { 
        category: "ğŸ› ï¸ ×©×œ×“×” (×ª××•× ×•×ª)", 
        items: [
            { name: "ğŸ”¥ × ×§×•×“×•×ª ×¨×™×ª×•×š", weight: 25, howTo: "×ª×—×ª ×’×•××™×•×ª ×”×“×œ×ª×•×ª - ×”×× ×”×¨×™×ª×•×›×™× ×¢×’×•×œ×™×?", ok: "×¨×™×ª×•×š ××¤×¢×œ ×¢×’×•×œ", notOk: "×ª×™×§×•×Ÿ ×—×•××¨ ××• ×¨×™×ª×•×š ×™×“× ×™" },
            { name: "ğŸ”§ ×‘×¨×’×™ ×›× ×¤×™×™×", weight: 15, howTo: "×—×¤×©×• ×¦×‘×¢ ××§×•×œ×£ ×¢×œ ×”×‘×¨×’×™× ×©××—×–×™×§×™× ××ª ×”×¤×—.", ok: "×‘×¨×’×™× ××§×•×¨×™×™×", notOk: "×¡×™×× ×™ ×¤×ª×™×—×” (×”×•×—×œ×£ ×—×œ×§)" }
        ] 
    }
];

let currentScore = 100;
let defects = [];

// --- ×¤×•× ×§×¦×™×•×ª ×‘×—×™×¨×” ---
function openPicker(type) {
    document.querySelectorAll('.popup-grid').forEach(p => p.classList.remove('active'));
    document.getElementById(type + '-popup').classList.add('active');
    
    const grid = document.getElementById(type + '-grid');
    grid.innerHTML = '';

    if(type === 'brand') {
        Object.keys(carData).forEach(b => addGridItem(grid, b, 'brand'));
    } else if(type === 'model') {
        const brand = document.getElementById('val-b').value;
        carData[brand].forEach(m => addGridItem(grid, m, 'model'));
    } else if(type === 'year') {
        for(let y=2025; y>=2010; y--) addGridItem(grid, y, 'year');
    }
}

function addGridItem(grid, val, type) {
    const div = document.createElement('div');
    div.className = 'grid-item';
    div.innerText = val;
    div.onclick = () => {
        document.getElementById('val-' + type.charAt(0)).value = val;
        document.getElementById(type + '-trigger').querySelector('span').innerText = val;
        document.getElementById(type + '-popup').classList.remove('active');
        
        if(type === 'brand') { enable('model'); reset('model'); reset('year'); }
        if(type === 'model') { enable('year'); reset('year'); }
    };
    grid.appendChild(div);
}

function filterGrid(type, query) {
    const grid = document.getElementById(type + '-grid');
    const items = type === 'brand' ? Object.keys(carData) : carData[document.getElementById('val-b').value];
    grid.innerHTML = '';
    items.filter(i => i.includes(query)).forEach(i => addGridItem(grid, i, type));
}

function enable(id) { document.getElementById(id + '-trigger').classList.remove('disabled'); }
function reset(id) { document.getElementById(id + '-trigger').querySelector('span').innerText = '×‘×—×¨...'; }

// --- AI Logic ---
async function startAI() {
    const b = document.getElementById('val-b').value;
    const m = document.getElementById('val-m').value;
    const y = document.getElementById('val-y').value;
    if(!b || !m || !y) return alert("×‘×—×¨ ×™×¦×¨×Ÿ, ×“×’× ×•×©× ×”");

    const btn = document.getElementById('btn-ai');
    btn.disabled = true;
    document.getElementById('loader').style.display = 'flex';

    try {
        const res = await fetch('/analyze-ai', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ brand:b, model:m, year:y })
        });
        const data = await res.json();
        renderAI(data.aiAnalysis);
    } catch(e) {
        alert("×©×’×™××ª ×ª×§×©×•×¨×ª ×¢× ×”×©×¨×ª");
    } finally {
        document.getElementById('loader').style.display = 'none';
        btn.disabled = false;
    }
}

function renderAI(ai) {
    const box = document.getElementById('ai-result-box');
    box.style.display = 'block';
    box.innerHTML = `
        <div style="background:var(--card-bg); padding:20px; border-radius:20px; border:1px solid var(--accent);">
            <div style="text-align:center; font-size:40px; font-weight:900; color:var(--accent);">${ai.reliability_score}</div>
            <p style="text-align:center; font-size:15px; color:var(--text-muted);">${ai.summary}</p>
            <div style="margin-top:15px;">
                <b style="color:var(--success)">âœ… ×™×ª×¨×•× ×•×ª:</b>
                <div style="font-size:13px; margin-bottom:10px;">${ai.pros.join(', ')}</div>
                <b style="color:var(--danger)">âŒ ×ª×§×œ×•×ª × ×¤×•×¦×•×ª:</b>
                <div style="font-size:13px;">${ai.common_faults.join(', ')}</div>
            </div>
        </div>
    `;
    box.scrollIntoView({behavior:'smooth'});
}

// --- Checklist Logic ---
function goToChecklist() {
    document.getElementById('screen-input').style.display = 'none';
    document.getElementById('screen-check').style.display = 'flex';
    const container = document.getElementById('checklist-content');
    
    checklistData.forEach((cat, cIdx) => {
        container.innerHTML += `<div class="category-header"><span class="category-title">${cat.category}</span></div>`;
        cat.items.forEach((item, iIdx) => {
            const id = `item-${cIdx}-${iIdx}`;
            container.innerHTML += `
                <div class="check-item">
                    <div class="check-item-header">
                        <div class="item-info">
                            <div class="info-btn" onclick="toggleHowTo('${id}')">i</div>
                            <span style="font-weight:600;">${item.name}</span>
                        </div>
                        <div id="cb-${id}" class="cb-custom" onclick="toggleItem('${id}', ${item.weight}, '${item.name}')"></div>
                    </div>
                    <div id="how-${id}" class="how-to-box">
                        ${item.howTo}
                        <span class="status-tag status-ok">âœ… ×ª×§×™×Ÿ: ${item.ok}</span>
                        <span class="status-tag status-not-ok">âŒ ×œ× ×ª×§×™×Ÿ: ${item.notOk}</span>
                    </div>
                </div>`;
        });
    });
    window.scrollTo(0,0);
}

function toggleHowTo(id) {
    const el = document.getElementById('how-' + id);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

function toggleItem(id, weight, name) {
    const cb = document.getElementById('cb-' + id);
    if(cb.classList.contains('bad')) {
        cb.classList.remove('bad');
        currentScore += weight;
        defects = defects.filter(d => d !== name);
    } else {
        cb.classList.add('bad');
        currentScore -= weight;
        defects.push(name);
    }
}

function finishCheck() {
    document.getElementById('screen-check').style.display = 'none';
    document.getElementById('screen-result').style.display = 'flex';
    
    const final = Math.max(0, currentScore);
    const gauge = document.getElementById('final-gauge');
    gauge.innerText = final;
    
    const color = final > 85 ? var(--success) : (final > 65 ? var(--plate-yellow) : var(--danger));
    gauge.style.color = color;
    gauge.style.borderColor = color;

    const status = document.getElementById('result-status');
    if(final > 85) status.innerText = "×¨×›×‘ ×‘××¦×‘ ××¦×•×™×Ÿ! âœ…";
    else if(final > 65) status.innerText = "××¦×‘ ×¡×‘×™×¨, ×“×•×¨×© ×”×ª×™×™×—×¡×•×ª âš ï¸";
    else status.innerText = "×œ× ×œ×’×¢×ª! ×¡×›× ×” âŒ";
    
    if(defects.length > 0) {
        document.getElementById('defects-box').style.display = 'block';
        const list = document.getElementById('defects-list');
        list.innerHTML = defects.map(d => `<li style="margin-bottom:5px;">${d}</li>`).join('');
    }
    window.scrollTo(0,0);
}

// ×¡×’×™×¨×ª ×¤×•×¤××¤×™× ×‘×œ×—×™×¦×” ×‘×—×•×¥
document.addEventListener('click', (e) => {
    if(!e.target.closest('.field-group')) {
        document.querySelectorAll('.popup-grid').forEach(p => p.classList.remove('active'));
    }
});
</script>

</body>
</html>
