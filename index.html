<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <style>
        :root { --primary: #00F2FF; --bg: #0A0A0C; --card: #16161D; --text: #E0E0E0; --danger: #FF3B3B; --success: #00FF85; --warning: #FFB800; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; -webkit-tap-highlight-color: transparent; }
        .container { padding: 20px; max-width: 500px; margin: auto; padding-bottom: 90px; }
        
        /* ×œ×•×—×™×ª */
        .plate-container { background: #FFB800; padding: 5px; border-radius: 12px; border: 3px solid #000; display: flex; align-items: center; margin-bottom: 15px; position: relative; box-shadow: 0 4px 15px rgba(255, 184, 0, 0.2); }
        .plate-input { background: none; border: none; font-size: 38px; font-weight: 900; width: 100%; text-align: center; outline: none; letter-spacing: 4px; font-family: monospace; z-index: 2; color: black; }
        .il-tag { background: #003399; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; position: absolute; left: 8px; font-weight: bold; z-index: 1; }

        /* ×›×¤×ª×•×¨×™× ×•×§×œ×˜×™× */
        select, input, .btn { width: 100%; padding: 16px; background: var(--card); border: 1px solid #333; color: #fff; border-radius: 14px; margin-bottom: 15px; font-size: 16px; box-sizing: border-box; transition: 0.2s; }
        select:focus, input:focus { border-color: var(--primary); outline: none; }
        
        .btn { background: #007AFF; font-weight: bold; cursor: pointer; border: none; margin-top: 5px; font-size: 18px; }
        .btn:active { transform: scale(0.98); }
        .btn-ai { background: linear-gradient(135deg, var(--primary), #7000FF); margin-top: 20px; box-shadow: 0 4px 20px rgba(0, 242, 255, 0.2); }
        .btn-finish { background: var(--success); color: #000; margin-top: 30px; font-weight: 800; }

        /* ×¡×˜×˜×•×¡ ×•×ª×•×¦××•×ª */
        #status-msg { text-align: center; font-weight: bold; min-height: 20px; margin-bottom: 10px; font-size: 14px; }
        #ai-result { display: none; background: rgba(0, 242, 255, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 12px; margin-top: 20px; line-height: 1.6; font-size: 15px; }

        /* ×¦'×§ ×œ×™×¡×˜ */
        .category { margin-top: 30px; color: var(--primary); font-size: 18px; font-weight: 800; border-bottom: 2px solid #222; padding-bottom: 8px; }
        .check-item { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .item-left { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .cb { width: 24px; height: 24px; border: 2px solid #555; border-radius: 6px; margin-left: 15px; flex-shrink: 0; transition: 0.2s; }
        .cb.checked { background: var(--danger); border-color: var(--danger); display: flex; align-items: center; justify-content: center; }
        .cb.checked::after { content: "âœ•"; color: white; font-weight: bold; }
        .info-btn { width: 30px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; cursor: pointer; }
        .tooltip { display: none; background: #222; padding: 12px; border-radius: 8px; font-size: 13px; color: #ccc; margin-top: 5px; border: 1px solid #444; line-height: 1.4; }

        /* ×¦×™×•×Ÿ ×¡×•×¤×™ */
        #score-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 25px; animation: fadeIn 0.3s; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 8px solid var(--success); display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: 900; color: var(--success); margin-bottom: 25px; box-shadow: 0 0 30px rgba(0, 255, 133, 0.2); }
        @keyframes fadeIn { from {opacity:0;} to {opacity:1;} }

        /* Loader */
        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loader-text" style="color:white; margin-top:15px; font-weight:bold;">×˜×•×¢×Ÿ...</p></div>

<div id="screen-input" class="container">
    <h1 style="text-align:center;">CarCheck <span style="color:var(--primary)">AI</span></h1>
    
    <div class="plate-container">
        <div class="il-tag"><span>IL</span></div>
        <input id="plate" class="plate-input" type="tel" placeholder="12345678" maxlength="8">
    </div>
    
    <button class="btn" onclick="superSearch()">ğŸ” ××™×ª×•×¨ ×¨×›×‘ (×¢×•×§×£ ×—×¡×™××•×ª)</button>
    <div id="status-msg"></div>

    <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
        <label style="color:#888; margin-bottom:5px; display:block;">×™×¦×¨×Ÿ:</label>
        <select id="brand" onchange="updateModels()"><option value="">×‘×—×¨ ×™×¦×¨×Ÿ...</option></select>
        
        <label style="color:#888; margin-bottom:5px; display:block;">×“×’×:</label>
        <select id="model" disabled><option value="">×‘×—×¨ ×™×¦×¨×Ÿ ×§×•×“×...</option></select>
        
        <label style="color:#888; margin-bottom:5px; display:block;">×©× ×”:</label>
        <input id="year" type="number" placeholder="×œ××©×œ: 2021">
        
        <button class="btn btn-ai" onclick="analyzeAI()">ğŸ¤– × ×ª×— ×××™× ×•×ª ×•×”××©×š</button>
    </div>

    <div id="ai-result"></div>
</div>

<div id="screen-check" class="container" style="display:none">
    <h2 id="check-header" style="text-align:center;"></h2>
    <div id="checklist-content"></div>
    <button class="btn btn-finish" onclick="calculateScore()">ğŸ“Š ×©×§×œ×œ ×¦×™×•×Ÿ ×¡×•×¤×™</button>
    <button class="btn" style="background:transparent; color:#666;" onclick="location.reload()">×™×¦×™××”</button>
</div>

<div id="score-overlay">
    <div class="score-circle" id="final-score">0</div>
    <h2 id="score-msg" style="color:white;"></h2>
    <p id="score-desc" style="color:#aaa; max-width:300px; margin-bottom:30px; line-height:1.5;"></p>
    <button class="btn" style="background:#25D366; color:white;" onclick="shareResult()">×©×ª×£ ×‘×•×•××˜×¡××¤ ğŸŸ¢</button>
    <button class="btn" style="background:#333; margin-top:15px;" onclick="location.reload()">×‘×“×™×§×” ×—×“×©×”</button>
</div>

<script>
// --- ××¡×“ × ×ª×•× ×™× ××œ× ---
const carDatabase = {
    "×××•×“×™": ["A1", "A3", "A4", "A6", "Q3", "Q5", "e-tron"],
    "××•×¤×œ": ["×§×•×¨×¡×”", "××¡×˜×¨×”", "××•×§×”", "×§×¨×•×¡×œ× ×“"],
    "BYD": ["Atto 3", "Han", "Dolphin"],
    "BMW": ["×¡×“×¨×” 1", "×¡×“×¨×” 3", "X1", "X3", "X5", "iX"],
    "×’'×™×¤": ["×¨× ×’×œ×¨", "×’×¨× ×“ ×¦'×™×¨×•×§×™", "×§×•××¤×¡"],
    "×’'×™×œ×™": ["Geometry C"],
    "×”×•× ×“×”": ["×¡×™×•×•×™×§", "×’'××–", "CR-V", "HR-V"],
    "×•×•×œ×•×•": ["S60", "XC40", "XC60", "XC90"],
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "C-HR", "RAV4", "×œ× ×“ ×§×¨×•×–×¨", "××™×™×’×•", "×¤×¨×™×•×¡", "×”×™×™×œ×§×¡"],
    "×˜×¡×œ×”": ["××•×“×œ 3", "××•×“×œ Y"],
    "×™×•× ×“××™": ["i10", "i20", "i30", "××™×•× ×™×§", "×˜×•×¡×•×Ÿ", "×¡× ×˜×” ×¤×”", "×§×•× ×”", "××œ× ×˜×¨×”", "×•× ×™×•"],
    "×××–×“×”": ["2", "3", "6", "CX-3", "CX-5", "CX-30"],
    "××™×¦×•×‘×™×©×™": ["×××•×˜×œ× ×“×¨", "ASX", "×¡×¤×™×™×¡ ×¡×˜××¨"],
    "× ×™×¡××Ÿ": ["××™×§×¨×”", "×’'×•×§", "×§×©×§××™", "××§×¡-×˜×¨×™×™×œ"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "×•×™×˜××¨×”", "×§×¨×•×¡××•×‘×¨", "×’'×™×× ×™", "××™×’× ×™×¡"],
    "×¡×§×•×“×”": ["××•×§×˜×‘×™×”", "×¡×•×¤×¨×‘", "×§×××™×§", "×§××¨×•×§", "×§×•×“×™××§", "×¤××‘×™×”"],
    "×¡×™××˜": ["××™×‘×™×–×”", "×œ××•×Ÿ", "××¨×•× ×”", "××˜×§×”"],
    "×¤×™×’'×•": ["208", "2008", "3008", "5008"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¨×™×•", "×¤×•×¨×˜×”", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§", "×¡×•×¨× ×˜×•", "EV6"],
    "×¨× ×•": ["×§×œ×™××•", "×§×¤×¦'×•×¨", "××’××Ÿ", "×’×¨× ×“ ×§×•×¤×”"],
    "×©×‘×¨×•×œ×˜": ["×¡×¤××¨×§", "×××œ×™×‘×•", "×˜×¨××§×¡"]
};

const checklistData = {
    "×× ×•×¢": [
        { name: "××¤×œ×¡ ×©××Ÿ", tip: "×”×•×¦× ××“×™×“. ×•×•×“× ×©××Ÿ ×‘×™×Ÿ ×”×§×•×•×™×. ×¦×‘×¢ ×©×—×•×¨/×—×•×. ×¦×‘×¢ '×˜×—×™× ×”' = ××™× ×‘×©××Ÿ (×¡×›× ×”!)." },
        { name: "× ×•×–×œ ×§×™×¨×•×¨", tip: "×‘×“×•×§ ×‘××™×›×œ ×¤×œ×¡×˜×™×§ (×›×©×”×× ×•×¢ ×§×¨!). ×”× ×•×–×œ ×¦×¨×™×š ×œ×”×™×•×ª ×‘×¦×‘×¢ (×™×¨×•×§/×•×¨×•×“) ×•×œ× ×—×œ×•×“×”." },
        { name: "× ×–×™×œ×•×ª", tip: "×—×¤×© ×¨×˜×™×‘×•×ª ×˜×¨×™×™×” ×¡×‘×™×‘ ×”×× ×•×¢ ×•××ª×—×ª ×œ×¨×›×‘." }
    ],
    "×’×™×¨ ×•×©×œ×“×”": [
        { name: "×”×¢×‘×¨×ª ×”×™×œ×•×›×™×", tip: "×”×¢×‘×¨ P-R-N-D. ×¦×¨×™×š ×œ×¢×‘×•×¨ ×—×œ×§ ×‘×œ×™ ××›×” ×—×–×§×”." },
        { name: "×”×¤×¨×©×™ ×¦×‘×¢", tip: "×”×¡×ª×›×œ ×‘×©××©. ×“×œ×ª ×›×”×” ×™×•×ª×¨ ××”×›× ×£? ×¡×™××Ÿ ×œ×ª××•× ×”." },
        { name: "×¦××™×’×™×", tip: "×‘×“×•×§ ×ª××¨×™×š (4 ×¡×¤×¨×•×ª). ×¦××™×’ ×™×‘×© ××• ××¢×œ 4 ×©× ×™× ×¤×¡×•×œ." }
    ],
    "×—×©××œ": [
        { name: "××–×’×Ÿ", tip: "××§×¨×¨ ×ª×•×š ×“×§×”? ×—×™××•× ×¢×•×‘×“?" },
        { name: "× ×•×¨×•×ª ××–×”×¨×”", tip: "×¤×ª×— ×¡×•×•×™×¥' - ×›×œ ×”× ×•×¨×•×ª × ×“×œ×§×•×ª? ×”× ×¢ - ×›×•×œ×Ÿ × ×›×‘×•×ª?" }
    ]
};

// ××ª×—×•×œ
const brandSel = document.getElementById('brand');
Object.keys(carDatabase).sort().forEach(b => brandSel.innerHTML += `<option value="${b}">${b}</option>`);

function updateModels() {
    const b = brandSel.value;
    const mSel = document.getElementById('model');
    mSel.innerHTML = '<option value="">×‘×—×¨ ×“×’×...</option>';
    if(b && carDatabase[b]) {
        mSel.disabled = false;
        carDatabase[b].forEach(m => mSel.innerHTML += `<option value="${m}">${m}</option>`);
    } else mSel.disabled = true;
}

// --- ×¤×•× ×§×¦×™×™×ª ×”×¢×œ ×”×—×“×©×”: ×¢×•×§×¤×ª ×—×¡×™××•×ª ---
async function superSearch() {
    let p = document.getElementById('plate').value.replace(/\D/g,'');
    if(p.length < 7) return showMsg("××¡×¤×¨ ×œ× ×ª×§×™×Ÿ", "#FFB800");
    
    showLoader("××—×¤×© ×‘-3 ×××’×¨×™× (×›×•×œ×œ ×¢×§×™×¤×ª ×—×¡×™××”)...");
    showMsg("", "white");
    
    // ×¨×©×™××ª ×××’×¨×™× ×¢× ×©××•×ª ×”×©×“×•×ª ×”××ª××™××™× ×œ×›×œ ××—×“
    const sources = [
        { id: "053ad243-5e8b-4334-8397-47883b740881", field: "mispar_rechev" }, // ×¨××©×™
        { id: "c8b9f9c8-46bd-494f-96ef-8ea4e9c64757", field: "MISPAR RECHEV" }, // × ×›×™×
        { id: "36bf1404-0be4-4c32-a269-6ce7885b7752", field: "mispar_rechev" }  // ×¨×™×§×•×œ
    ];

    let found = null;

    // × ×™×¡×™×•×Ÿ 1: ×—×™×‘×•×¨ ×™×©×™×¨ ×¨×’×™×œ (××”×™×¨)
    for (let src of sources) {
        try {
            // ×©×™××•×© ×‘-Filters ×‘××§×•× Q ×œ×“×™×•×§ ××§×¡×™××œ×™
            const filter = JSON.stringify({ [src.field]: p });
            const url = `https://data.gov.il/api/3/action/datastore_search?resource_id=${src.id}&filters=${filter}`;
            
            const res = await fetch(url);
            const data = await res.json();
            
            if(data.success && data.result.records.length > 0) {
                found = data.result.records[0];
                break;
            }
        } catch(e) { console.log("Direct failed, trying proxy..."); }
    }

    // × ×™×¡×™×•×Ÿ 2: ×× ×”×—×™×‘×•×¨ ×”×™×©×™×¨ × ×›×©×œ (CORS), ×× ×¡×™× ×“×¨×š Proxy ×¦×™×‘×•×¨×™
    if (!found) {
        for (let src of sources) {
            try {
                const filter = JSON.stringify({ [src.field]: p });
                // ×”×•×¡×¤×ª Proxy ×œ×¤× ×™ ×”×›×ª×•×‘×ª
                const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(`https://data.gov.il/api/3/action/datastore_search?resource_id=${src.id}&filters=${filter}`);
                
                const res = await fetch(proxyUrl);
                const data = await res.json();
                
                if(data.success && data.result.records.length > 0) {
                    found = data.result.records[0];
                    break;
                }
            } catch(e) { console.log("Proxy failed too."); }
        }
    }

    if (found) {
        fillData(found);
    } else {
        // × ×™×¡×™×•×Ÿ ××—×¨×•×Ÿ: ×©×¨×ª ×”×’×™×‘×•×™ ×©×œ× ×•
        try {
            const srvRes = await fetch('/get-car-details', {
                method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({plate:p})
            });
            const srvData = await srvRes.json();
            if(srvData.success) fillData(srvData.data);
            else showMsg("âŒ ×œ× × ××¦×. × × ×œ××œ× ×™×“× ×™×ª.", "#FF3B3B");
        } catch(e) { showMsg("âš ï¸ ×›×œ ×”×××’×¨×™× × ×›×©×œ×•. ×”×–×Ÿ ×™×“× ×™×ª.", "#FF3B3B"); }
    }
    
    hideLoader();
}

function fillData(c) {
    // × ×¨××•×œ ×©××•×ª ×©×“×•×ª ×›×™ ×”× ××©×ª× ×™× ×‘×™×Ÿ ×××’×¨×™×
    const year = c.shnat_yitzur || c.SHNAT_YITZUR || c.shnat_yitzur_loazi || "";
    const rawBrand = c.tozeret_nm || c.TOZERET_NM || c.yatzran_nm || "";
    
    document.getElementById('year').value = year;
    
    let matched = false;
    for(let opt of brandSel.options) {
        if(rawBrand.includes(opt.value) && opt.value !== "") {
            brandSel.value = opt.value;
            updateModels();
            matched = true;
            break;
        }
    }
    
    if(matched) showMsg("âœ… ×¨×›×‘ ××•×ª×¨ ×‘×”×¦×œ×—×”!", "#00FF85");
    else showMsg(`× ××¦×: ${rawBrand}. ×‘×—×¨ ×™×¦×¨×Ÿ ×™×“× ×™×ª.`, "#FFB800");
}

async function analyzeAI() {
    const b = brandSel.value, m = document.getElementById('model').value, y = document.getElementById('year').value;
    if(!b || !m) return alert("×‘×—×¨ ×¨×›×‘");

    showLoader("AI ×× ×ª×— (×–×” ×œ×•×§×— ×›××” ×©× ×™×•×ª)...");
    try {
        const res = await fetch('/analyze-ai', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({brand:b, model:m, year:y})
        });
        const data = await res.json();
        
        const resDiv = document.getElementById('ai-result');
        resDiv.style.display = 'block';
        
        if(data.success) {
            resDiv.innerHTML = `<strong>×“×•×— ×××™× ×•×ª AI:</strong><br>${data.aiAnalysis.replace(/\n/g, '<br>')}`;
            // ×”×•×¡×¤×ª ×›×¤×ª×•×¨ ×”××©×š
            if(!document.getElementById('cont-btn')) {
                const btn = document.createElement('button');
                btn.id = 'cont-btn';
                btn.className = 'btn';
                btn.style.marginTop = '15px';
                btn.innerText = '×”××©×š ×œ×¦\'×§ ×œ×™×¡×˜ â”';
                btn.onclick = goToCheck;
                document.getElementById('screen-input').appendChild(btn);
            }
        } else {
            resDiv.innerText = "×”-AI ×¢××•×¡ ×›×¨×’×¢. ×”××©×š ×œ×‘×“×™×§×” ×™×“× ×™×ª.";
        }
    } catch(e) { alert("×©×’×™××ª ×©×¨×ª AI"); } 
    finally { hideLoader(); }
}

function goToCheck() {
    document.getElementById('screen-input').style.display = 'none';
    document.getElementById('screen-check').style.display = 'block';
    document.getElementById('check-header').innerText = `${brandSel.value} ${document.getElementById('model').value}`;
    renderList();
}

function renderList() {
    let h = "", i=0;
    const aiText = document.getElementById('ai-result').innerHTML;
    if(aiText) h += `<div style="font-size:14px; margin-bottom:20px; padding:10px; border:1px solid var(--primary); border-radius:10px;">${aiText}</div>`;

    for(let cat in checklistData) {
        h += `<div class="category">${cat}</div>`;
        checklistData[cat].forEach(item => {
            i++;
            h += `<div class="check-item">
                <div class="item-left" onclick="toggleCB(${i})"><div class="cb" id="cb_${i}"></div><span>${item.name}</span></div>
                <div class="info-btn" onclick="toggleTip(${i})">?</div>
            </div><div class="tooltip" id="tip_${i}">${item.tip}</div>`;
        });
    }
    document.getElementById('checklist-content').innerHTML = h;
}

function toggleCB(id) { document.getElementById('cb_'+id).classList.toggle('checked'); }
function toggleTip(id) { const el = document.getElementById('tip_'+id); el.style.display = el.style.display==='block'?'none':'block'; }

function calculateScore() {
    const total = document.querySelectorAll('.cb').length;
    const checked = document.querySelectorAll('.cb.checked').length;
    const score = Math.max(0, 100 - Math.round((checked/total)*100));
    
    document.getElementById('final-score').innerText = score;
    const msg = document.getElementById('score-msg');
    const desc = document.getElementById('score-desc');
    
    if(score > 80) { msg.innerText = "××•××œ×¥ âœ…"; desc.innerText = "×¨×›×‘ ×‘××¦×‘ ×˜×•×‘ ×××•×“. × ×™×ª×Ÿ ×œ×”×ª×§×“×."; }
    else if(score > 60) { msg.innerText = "×›×“××™ ×œ×‘×“×•×§ âš ï¸"; desc.innerText = "×™×©× × ××¡×¤×¨ ×¨×™×’'×§×˜×™×. ×—×•×‘×” ×‘×“×™×§×” ×‘××•×¡×š."; }
    else { msg.innerText = "×œ× ××•××œ×¥ âŒ"; desc.innerText = "×¨×›×‘ ×‘××¦×‘ ×™×¨×•×“. ×œ× ××•××œ×¥ ×œ×§× ×™×™×”."; }
    
    document.getElementById('score-overlay').style.display = 'flex';
}

function shareResult() {
    const txt = `×‘×“×™×§×ª ×¨×›×‘: ${document.getElementById('check-header').innerText}\n×¦×™×•×Ÿ: ${document.getElementById('final-score').innerText}\n×¡×˜×˜×•×¡: ${document.getElementById('score-msg').innerText}`;
    window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`);
}

function showLoader(txt) { document.getElementById('loader-text').innerText = txt; document.getElementById('loader').style.display = 'flex'; }
function hideLoader() { document.getElementById('loader').style.display = 'none'; }
function showMsg(txt, col) { const el = document.getElementById('status-msg'); el.innerText = txt; el.style.color = col; }
</script>
</body>
</html>
