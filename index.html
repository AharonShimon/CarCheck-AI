<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <style>
        :root { --primary: #00F2FF; --bg: #0A0A0C; --card: #16161D; --text: #E0E0E0; --danger: #FF3B3B; --success: #00FF85; --warning: #FFB800; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; }
        .container { padding: 20px; max-width: 500px; margin: auto; padding-bottom: 90px; }
        
        .plate-container { background: #FFB800; padding: 5px; border-radius: 12px; border: 3px solid #000; display: flex; align-items: center; margin-bottom: 15px; position: relative; }
        .plate-input { background: none; border: none; font-size: 38px; font-weight: 900; width: 100%; text-align: center; outline: none; letter-spacing: 4px; font-family: monospace; z-index: 2; color:black; }
        .il-tag { background: #003399; color: white; padding: 4px 8px; border-radius: 4px; font-size: 11px; position: absolute; left: 8px; font-weight: bold; z-index: 1; }

        select, input, .btn { width: 100%; padding: 16px; background: var(--card); border: 1px solid #333; color: #fff; border-radius: 14px; margin-bottom: 15px; font-size: 16px; box-sizing: border-box; }
        .btn { background: #007AFF; font-weight: bold; cursor: pointer; border: none; margin-top: 5px; }
        .btn-ai { background: linear-gradient(135deg, var(--primary), #7000FF); margin-top: 20px; }
        .btn-finish { background: var(--success); color: #000; margin-top: 20px; }

        #ai-result { display: none; background: rgba(0, 242, 255, 0.1); border: 1px solid var(--primary); padding: 15px; border-radius: 12px; margin-top: 20px; line-height: 1.5; }
        #status-msg { text-align: center; font-weight: bold; min-height: 20px; margin-bottom: 10px; }

        .category { margin-top: 30px; color: var(--primary); font-size: 18px; font-weight: 800; border-bottom: 2px solid #222; padding-bottom: 8px; }
        .check-item { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 10px; display: flex; justify-content: space-between; align-items: center; }
        .item-left { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .cb { width: 24px; height: 24px; border: 2px solid #555; border-radius: 6px; margin-left: 15px; flex-shrink: 0; }
        .cb.checked { background: var(--danger); border-color: var(--danger); display: flex; align-items: center; justify-content: center; }
        .cb.checked::after { content: "âœ•"; color: white; font-weight: bold; }
        .info-btn { width: 30px; height: 30px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--primary); font-weight: bold; cursor: pointer; }
        .tooltip { display: none; background: #222; padding: 10px; border-radius: 8px; font-size: 13px; color: #ccc; margin-top: 5px; border: 1px solid #444; }

        #score-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.96); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 25px; }
        .score-circle { width: 140px; height: 140px; border-radius: 50%; border: 8px solid var(--success); display: flex; align-items: center; justify-content: center; font-size: 50px; font-weight: 900; color: var(--success); margin-bottom: 25px; box-shadow: 0 0 30px rgba(0, 255, 133, 0.2); }

        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loader-text" style="color:white; margin-top:15px;">×˜×•×¢×Ÿ...</p></div>

<div id="screen-input" class="container">
    <h1 style="text-align:center;">CarCheck <span style="color:var(--primary)">AI</span></h1>
    
    <div class="plate-container">
        <div class="il-tag"><span>IL</span></div>
        <input id="plate" class="plate-input" type="tel" placeholder="12345678" maxlength="8">
    </div>
    
    <button class="btn" onclick="superSearch()">ğŸ” ××™×ª×•×¨ ×¨×›×‘ (Multi-Source)</button>
    <div id="status-msg"></div>

    <div style="margin-top:20px; border-top:1px solid #333; padding-top:20px;">
        <label>×™×¦×¨×Ÿ:</label>
        <select id="brand" onchange="updateModels()"><option value="">×‘×—×¨ ×™×¦×¨×Ÿ...</option></select>
        <label>×“×’×:</label>
        <select id="model" disabled><option value="">×‘×—×¨ ×™×¦×¨×Ÿ ×§×•×“×...</option></select>
        <label>×©× ×”:</label>
        <input id="year" type="number" placeholder="×œ××©×œ: 2021">
        <button class="btn btn-ai" onclick="analyzeAI()">ğŸ¤– × ×ª×— ×××™× ×•×ª ×•×”××©×š</button>
    </div>
    <div id="ai-result"></div>
</div>

<div id="screen-check" class="container" style="display:none">
    <h2 id="check-header" style="text-align:center;"></h2>
    <div id="checklist-content"></div>
    <button class="btn btn-finish" onclick="calculateScore()">ğŸ“Š ×©×§×œ×œ ×¦×™×•×Ÿ ×¡×•×¤×™</button>
    <button class="btn" style="background:transparent; color:#666;" onclick="location.reload()">×™×¦×™××”</button>
</div>

<div id="score-overlay">
    <div class="score-circle" id="final-score">0</div>
    <h2 id="score-msg" style="color:white;"></h2>
    <p id="score-desc" style="color:#aaa; max-width:300px; margin-bottom:30px;"></p>
    <button class="btn" style="background:#25D366; color:white;" onclick="shareResult()">Whatsapp ×©×ª×£</button>
    <button class="btn" style="background:#333; margin-top:15px;" onclick="location.reload()">×‘×“×™×§×” ×—×“×©×”</button>
</div>

<script>
// --- ××¡×“ × ×ª×•× ×™× ---
const carDatabase = {
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "RAV4", "C-HR", "×œ× ×“ ×§×¨×•×–×¨", "××™×™×’×•"],
    "×™×•× ×“××™": ["i10", "i20", "i30", "××™×•× ×™×§", "×˜×•×¡×•×Ÿ", "×¡× ×˜×” ×¤×”", "×§×•× ×”"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¨×™×•", "×¤×•×¨×˜×”", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§"],
    "×××–×“×”": ["2", "3", "6", "CX-5", "CX-30"],
    "××™×¦×•×‘×™×©×™": ["×××•×˜×œ× ×“×¨", "ASX", "×¡×¤×™×™×¡ ×¡×˜××¨"],
    "× ×™×¡××Ÿ": ["××™×§×¨×”", "×’'×•×§", "×§×©×§××™"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "×•×™×˜××¨×”", "×§×¨×•×¡××•×‘×¨", "×’'×™×× ×™"],
    "×¡×§×•×“×”": ["××•×§×˜×‘×™×”", "×¡×•×¤×¨×‘", "×§××¨×•×§", "×§×•×“×™××§"],
    "×”×•× ×“×”": ["×¡×™×•×•×™×§", "×’'××–", "CR-V"],
    "×¡×™××˜": ["××™×‘×™×–×”", "×œ××•×Ÿ", "××¨×•× ×”", "××˜×§×”"],
    "×©×‘×¨×•×œ×˜": ["×¡×¤××¨×§", "×××œ×™×‘×•", "×˜×¨××§×¡"],
    "×¤×™×’'×•": ["208", "3008", "2008"],
    "×¨× ×•": ["×§×œ×™××•", "×§×¤×¦'×•×¨", "××’××Ÿ"],
    "×××•×“×™": ["A3", "Q3", "Q5"],
    "BMW": ["×¡×“×¨×” 3", "X1", "X3"],
    "×˜×¡×œ×”": ["××•×“×œ 3", "××•×“×œ Y"],
    "BYD": ["Atto 3", "Dolphin"],
    "×’'×™×œ×™": ["Geometry C"]
};

// --- ×˜×§×¡×˜×™× ×œ×’×™×‘×•×™ (×‘××§×¨×” ×©×”-AI ×¢××•×¡) ---
const backupAI = {
    "×˜×•×™×•×˜×”": "×××™× ×•×ª ××•×¤×ª×™×ª. ×‘×“×•×§ ×”×™×¡×˜×•×¨×™×™×ª ×˜×™×¤×•×œ×™× ×¡×“×™×¨×” ×•××¦×‘ ×¡×•×œ×œ×” ×‘×“×’××™× ×”×™×‘×¨×™×“×™×™×.",
    "×”×•× ×“×”": "×××™×Ÿ ×××•×“. ×©×™× ×œ×‘ ×œ×ª×•×©×‘×•×ª ×× ×•×¢ ×•×’×™×¨, ×•×œ××¢×¨×›×ª ×”××™×–×•×’.",
    "×™×•× ×“××™": "×¨×›×‘ ×¡×•×¡×™ ×¢×‘×•×“×”. ×‘×“×•×§ ××ª ××¦×‘ ×”×’×™×¨ ×”×¨×•×‘×•×˜×™ (×‘×“×’××™× ××¡×•×™××™×) ×•××¢×¨×›×ª ×”×”×™×’×•×™.",
    "×§×™×”": "×××™× ×•×ª ×’×‘×•×”×”. ×‘×“×•×§ ×—×™×™×©× ×™ ×—××¦×Ÿ ×•×¨×¢×©×™× ××”×¤×œ×¡×˜×™×§×” ×”×¤× ×™××™×ª.",
    "×××–×“×”": "×××™×Ÿ ×•××”× ×”. ×‘×“×•×§ ×ª×•×©×‘×•×ª ×‘×•×œ××™×, ×•××¡×š ××•×œ×˜×™××“×™×” (× ×•×˜×” ×œ×”×™×¡×“×§ ×‘×©××©).",
    "× ×™×¡××Ÿ": "×‘×“×•×§ ×”×™×˜×‘ ××ª ×”×’×™×¨ ×”×¨×¦×™×£ (× ×§×•×“×ª ×ª×•×¨×¤×”) ×•××¢×¨×›×ª ×”×§×™×¨×•×¨.",
    "××™×¦×•×‘×™×©×™": "×××™×Ÿ ××š ×¤×©×•×˜. ×‘×“×•×§ ×‘×•×œ××™× ××—×•×¨×™×™× ×•××¢×¨×›×ª ×”××–×’×Ÿ.",
    "×¡×•×–×•×§×™": "×¤×©×•×˜ ×•×××™×Ÿ. ×‘×“×•×§ ×—×œ×•×“×” ×‘×“×’××™ ×©×˜×— ×•××¡×¨×§ ×”×’×”.",
    "×¡×§×•×“×”": "× ×•×—×•×ª ××¦×•×™× ×ª. ×—×•×‘×” ×œ×‘×“×•×§ ×’×™×¨ DSG ×•××©××‘×ª ××™×.",
    "×¤×•×œ×§×¡×•×•×’×Ÿ": "××™×›×•×ª ×’×‘×•×”×”. ×¨×’×™×© ×œ×”×–× ×—×”. ×‘×“×•×§ ×˜×•×¨×‘×•, ×’×™×¨ ×•××©××‘×ª ××™×.",
    "×¡×™××˜": "×¦×¢×™×¨ ×•×–×¨×™×–. ×‘×“×•×§ ×’×™×¨ DSG, ×ª×¨××•×¡×˜×˜ ×•××©××‘×ª ××™×.",
    "×¤×™×’'×•": "× ×•×—×•×ª ×˜×•×‘×”. ×‘×“×•×§ ×¨×¦×•×¢×ª ×˜×™×™××™× ×’ (×‘×“×’××™ 1.2 ×˜×•×¨×‘×•) ×•××¢×¨×›×ª ××•×¨×™××” ×‘×“×™×–×œ.",
    "×¡×™×˜×¨×•××Ÿ": "×‘×“×•×§ ×¨×¦×•×¢×ª ×˜×™×™××™× ×’ ××ª×¤×•×¨×¨×ª (×‘×“×’××™ 1.2) ×•××¢×¨×›×ª ×—×©××œ.",
    "×¨× ×•": "×‘×˜×™×—×•×ª×™. ×‘×“×•×§ ×’×™×¨ ×¨×•×‘×•×˜×™ ×•××¢×¨×›×ª ×—×©××œ ××¨×›×–×™×ª.",
    "×©×‘×¨×•×œ×˜": "×× ×•×¢×™× ×—×–×§×™×. ×‘×“×•×§ ××¢×¨×›×ª ×§×™×¨×•×¨ (×¡×“×§×™× ×‘××™×›×œ ×¢×•×“×¤×™×) ×•×˜×•×¨×‘×•.",
    "BMW": "×”× ××” ×× ×”×™×’×”. ×‘×“×•×§ × ×–×™×œ×•×ª ×©××Ÿ, ××¢×¨×›×ª ×§×™×¨×•×¨ ×•××¢×¨×›×ª ×—×©××œ.",
    "××¨×¦×“×¡": "×™×•×§×¨×ª×™. ×¢×œ×•×™×•×ª ××—×–×§×” ×’×‘×•×”×•×ª. ×‘×“×•×§ ×—×™×™×©× ×™×, ××ª×œ×™ ××•×•×™×¨ ×•××¢×¨×›×ª ×—×©××œ.",
    "×××•×“×™": "×˜×›× ×•×œ×•×’×™. ×‘×“×•×§ ×¦×¨×™×›×ª ×©××Ÿ ×‘×× ×•×¢×™ ×˜×•×¨×‘×• ×•×’×™×¨ S-Tronic.",
    "×˜×¡×œ×”": "×—×©××œ×™ ×—×–×§. ×‘×“×•×§ ×¦××™×’×™×, ×‘×•×œ××™×, ×•×’×™××•×¨ ×¤× ×™××™/×—×™×¦×•× ×™.",
    "BYD": "×—×©××œ×™ ×¤×•×¤×•×œ×¨×™. ×‘×“×•×§ ×’×¨×¡×ª ×ª×•×›× ×” ×•××¦×‘ ×¦××™×’×™×.",
    "×’'×™×œ×™": "×ª××•×¨×” ×˜×•×‘×”. ×‘×“×•×§ ×‘××’×™× ×‘××•×œ×˜×™××“×™×” ×•××™×›×•×ª ×”×¨×›×‘×”.",
    "default": "×“×’× ×–×” × ×—×©×‘ ×¡×‘×™×¨. ××•××œ×¥ ×œ×‘×¦×¢ ×‘×“×™×§×” ×™×¡×•×“×™×ª ×‘××•×¡×š ×œ×¤× ×™ ×§× ×™×”."
};

const checklistData = {
    "×× ×•×¢": [{name:"×©××Ÿ ×× ×•×¢ (××¤×œ×¡/×¦×‘×¢)", tip:"×‘×“×•×§ ×‘××“×™×“. ×©×—×•×¨ ×–×” ×ª×§×™×Ÿ. '×˜×—×™× ×”' ×–×” ××¡×•×Ÿ."}, {name:"× ×•×–×œ ×§×™×¨×•×¨", tip:"×¦×‘×¢×•× ×™ (×™×¨×•×§/×•×¨×•×“). ×œ× ××™ ×‘×¨×–!"}, {name:"× ×–×™×œ×•×ª", tip:"×¨×˜×™×‘×•×ª ×¡×‘×™×‘ ×”×× ×•×¢/×’×™×¨."}],
    "××¨×›×‘": [{name:"×”×¤×¨×©×™ ×¦×‘×¢", tip:"×“×œ×ª ×›×”×” ×™×•×ª×¨ ××›× ×£ = ×ª××•× ×”."}, {name:"×¦××™×’×™×", tip:"×‘×œ×™ ×™×•×‘×©. ×ª××¨×™×š ×¢×“ 4 ×©× ×™×."}, {name:"×¤× ×¡×™×", tip:"×œ× ×¢×›×•×¨×™× ××• ×©×‘×•×¨×™×."}],
    "×—×©××œ": [{name:"××–×’×Ÿ", tip:"××§×¤×™× ×ª×•×š ×“×§×”?"}, {name:"×—×œ×•× ×•×ª", tip:"×¢×•×œ×™×/×™×•×¨×“×™× ×—×œ×§?"}, {name:"× ×•×¨×•×ª ××–×”×¨×”", tip:"× ×“×œ×§×•×ª ×‘×¡×•×•×™×¥ ×•× ×›×‘×•×ª ×‘×”× ×¢×”."}]
};

// ××ª×—×•×œ
const brandSel = document.getElementById('brand');
Object.keys(carDatabase).sort().forEach(b => brandSel.innerHTML += `<option value="${b}">${b}</option>`);

function updateModels() {
    const b = brandSel.value;
    const mSel = document.getElementById('model');
    mSel.innerHTML = '<option value="">×‘×—×¨ ×“×’×...</option>';
    if(b && carDatabase[b]) {
        mSel.disabled = false;
        carDatabase[b].forEach(m => mSel.innerHTML += `<option value="${m}">${m}</option>`);
    } else mSel.disabled = true;
}

// --- ××™×ª×•×¨ ×¨×›×‘ ×—×›× (×¢× Proxy ×œ×¢×§×™×¤×ª ×—×¡×™××•×ª) ---
async function superSearch() {
    let p = document.getElementById('plate').value.replace(/\D/g,'');
    if(p.length < 7) return showMsg("××¡×¤×¨ ×œ× ×ª×§×™×Ÿ", "orange");
    
    showLoader("××—×¤×© ×‘×××’×¨×™×...");
    showMsg("", "white");
    
    // ×©×™××•×© ×‘-Filters ×‘××§×•× q ×œ×“×™×•×§ ××§×¡×™××œ×™
    const resourceId = "053ad243-5e8b-4334-8397-47883b740881";
    const filter = JSON.stringify({ "mispar_rechev": p });
    
    // URL ×™×©×™×¨
    const directUrl = `https://data.gov.il/api/3/action/datastore_search?resource_id=${resourceId}&filters=${filter}`;
    // URL ×“×¨×š ×¤×¨×•×§×¡×™ (×œ×¢×§×™×¤×ª ×—×¡×™××•×ª)
    const proxyUrl = `https://corsproxy.io/?` + encodeURIComponent(directUrl);

    try {
        // ×× ×¡×™× ×™×©×™×¨
        let res = await fetch(directUrl).catch(() => null);
        let data = res ? await res.json() : null;

        // ×× × ×›×©×œ, ×× ×¡×™× ×¤×¨×•×§×¡×™
        if (!data || !data.success) {
            console.log("Direct failed, trying proxy...");
            res = await fetch(proxyUrl);
            data = await res.json();
        }

        if (data.success && data.result.records.length > 0) {
            fillData(data.result.records[0]);
        } else {
            showMsg("âŒ ×¨×›×‘ ×œ× × ××¦× ×‘×××’×¨. ×”×–×Ÿ ×™×“× ×™×ª.", "#FF3B3B");
        }
    } catch(e
