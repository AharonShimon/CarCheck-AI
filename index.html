<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CarCheck AI Pro</title>
    <style>
        :root { --primary: #00F2FF; --accent: #7000FF; --bg: #0A0A0C; --card: #16161D; --text: #E0E0E0; --danger: #FF3B3B; --success: #00FF85; --warning: #FFB800; }
        body { font-family: -apple-system, system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; direction: rtl; }
        .container { padding: 20px; max-width: 500px; margin: auto; padding-bottom: 80px; }
        
        /* ×œ×•×—×™×ª */
        .plate-container { background: #FFB800; padding: 5px; border-radius: 12px; border: 3px solid #000; display: flex; align-items: center; position: relative; margin-bottom: 15px; }
        .plate-input { background: none; border: none; font-size: 35px; font-weight: 900; width: 100%; text-align: center; outline: none; color: #000; letter-spacing: 3px; font-family: monospace; }
        .il-tag { background: #003399; color: white; padding: 3px 6px; border-radius: 4px; font-size: 10px; position: absolute; left: 8px; display: flex; flex-direction: column; align-items: center; line-height: 1; }

        /* ×§×œ×˜ ×•×“×¨×•×¤×“××•×Ÿ */
        select, .ios-field { width: 100%; padding: 15px; background: var(--card); border: 1px solid #333; color: #fff; border-radius: 14px; margin-bottom: 12px; font-size: 17px; appearance: none; box-sizing: border-box; }
        label { display: block; margin-bottom: 5px; color: #888; font-size: 14px; }
        
        .btn { border: none; padding: 16px; border-radius: 16px; font-size: 18px; font-weight: 700; width: 100%; cursor: pointer; transition: 0.3s; }
        .btn-blue { background: #007AFF; color: white; margin-bottom: 10px; }
        .btn-ai { background: linear-gradient(135deg, var(--primary), var(--accent)); color: white; }
        .btn-finish { background: var(--success); color: #000; margin-top: 20px; box-shadow: 0 4px 15px rgba(0, 255, 133, 0.3); }

        /* ×¦'×§ ×œ×™×¡×˜ */
        .category { margin-top: 25px; color: var(--primary); font-weight: bold; border-bottom: 1px solid #333; padding-bottom: 5px; }
        .check-item { background: var(--card); padding: 15px; border-radius: 12px; margin-top: 10px; display: flex; align-items: center; justify-content: space-between; }
        .item-label { display: flex; align-items: center; flex-grow: 1; cursor: pointer; }
        .cb { width: 26px; height: 26px; border: 2px solid #555; border-radius: 6px; margin-left: 15px; flex-shrink: 0; }
        .cb.checked { background: var(--danger); border-color: var(--danger); display: flex; align-items: center; justify-content: center; }
        .cb.checked::after { content: "âœ•"; color: white; font-weight: bold; }
        
        .info-btn { background: #333; color: var(--primary); width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; }
        .tooltip { display: none; background: #222; padding: 12px; border-radius: 8px; font-size: 14px; color: #bbb; margin-top: 5px; border: 1px solid #444; line-height: 1.4; }

        /* ××¡×š ×¦×™×•×Ÿ */
        #score-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 20px; }
        .score-circle { width: 120px; height: 120px; border-radius: 50%; border: 6px solid var(--success); display: flex; align-items: center; justify-content: center; font-size: 45px; font-weight: 900; color: var(--success); margin-bottom: 20px; }

        #loader { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 3000; flex-direction: column; align-items: center; justify-content: center; }
        .spinner { width: 40px; height: 40px; border: 4px solid #333; border-top-color: var(--primary); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>

<div id="loader"><div class="spinner"></div><p id="loader-text" style="color:white; margin-top:15px;">×˜×•×¢×Ÿ...</p></div>

<div id="screen-input" class="container">
    <h1>CarCheck AI <small style="font-size: 12px; color: var(--primary);">PRO</small></h1>
    <div class="plate-container">
        <div class="il-tag"><span>IL</span><span>×™×©×¨××œ</span></div>
        <input id="plate" class="plate-input" type="tel" placeholder="12345678" maxlength="8">
    </div>
    <button class="btn btn-blue" onclick="getCarDetails()">ğŸ” ××©×•×š × ×ª×•× ×™ ×œ×•×—×™×ª</button>
    <div id="status-msg" style="text-align:center; margin-bottom:10px; font-weight:bold;"></div>

    <div style="margin-top:10px;">
        <label>×™×¦×¨×Ÿ:</label>
        <select id="brand" onchange="updateModels()"><option value="">×‘×—×¨ ×™×¦×¨×Ÿ...</option></select>
        <label>×“×’×:</label>
        <select id="model" disabled><option value="">×‘×—×¨ ×™×¦×¨×Ÿ ×§×•×“×...</option></select>
        <label>×©× ×”:</label>
        <input id="year" class="ios-field" type="number" placeholder="×©× ×ª ×™×™×¦×•×¨">
        <button class="btn btn-ai" onclick="analyzeAI()">ğŸ¤– × ×ª×— ×××™× ×•×ª ×•×”×ª×—×œ ×‘×“×™×§×”</button>
    </div>
    <div id="ai-result" style="display:none; background:var(--card); padding:15px; border-radius:15px; margin-top:15px; font-size:14px; border:1px solid var(--primary); line-height:1.5;"></div>
</div>

<div id="screen-check" class="container" style="display:none">
    <h2 id="check-car-name" style="text-align:center;"></h2>
    <div id="checklist-content"></div>
    <button class="btn btn-finish" onclick="calculateScore()">ğŸ“Š ×©×§×œ×œ ×¦×™×•×Ÿ ×¡×•×¤×™</button>
</div>

<div id="score-overlay">
    <div class="score-circle" id="final-score">0</div>
    <h2 id="score-msg" style="color:white;"></h2>
    <p id="score-desc" style="color:#888; margin-bottom:30px;"></p>
    <button class="btn btn-blue" onclick="location.reload()">×‘×“×™×§×” ×—×“×©×”</button>
</div>

<script>
const carDatabase = {
    "×××•×“×™": ["A1", "A3", "A4", "A5", "A6", "Q2", "Q3", "Q5", "Q7", "Q8", "e-tron"],
    "××•×¤×œ": ["×§×•×¨×¡×”", "××¡×˜×¨×”", "××•×§×”", "×§×¨×•×¡×œ× ×“", "×’×¨× ×“×œ× ×“"],
    "BYD": ["Atto 3", "Han", "Dolphin", "Seal"],
    "BMW": ["×¡×“×¨×” 1", "×¡×“×¨×” 3", "×¡×“×¨×” 5", "X1", "X3", "X5", "iX"],
    "×’'×™×¤": ["×¨× ×’×œ×¨", "×’×¨× ×“ ×¦'×™×¨×•×§×™", "×§×•××¤×¡", "×¨× ×’×™×™×“"],
    "×’'×™×œ×™": ["Geometry C"],
    "×“××¦'×™×”": ["×“××¡×˜×¨", "×¡× ×“×¨×•", "×’'×•×’×¨"],
    "×”×•× ×“×”": ["×¡×™×•×•×™×§", "×’'××–", "CR-V", "HR-V"],
    "×•×•×œ×•×•": ["S60", "XC40", "XC60", "XC90"],
    "×˜×•×™×•×˜×”": ["×§×•×¨×•×œ×”", "×™××¨×™×¡", "×™××¨×™×¡ ×§×¨×•×¡", "C-HR", "RAV4", "×œ× ×“ ×§×¨×•×–×¨", "×”×™×™×œ×§×¡", "×¤×¨×™×•×¡", "××™×™×’×•"],
    "×˜×¡×œ×”": ["××•×“×œ 3", "××•×“×œ Y", "××•×“×œ S"],
    "×™×•× ×“××™": ["i10", "i20", "i30", "××œ× ×˜×¨×”", "××™×•× ×™×§", "××™×•× ×™×§ 5", "×˜×•×¡×•×Ÿ", "×¡× ×˜×” ×¤×”", "×§×•× ×”", "×•× ×™×•"],
    "×œ×§×¡×•×¡": ["UX", "NX", "RX", "ES"],
    "×××–×“×”": ["2", "3", "6", "CX-3", "CX-30", "CX-5", "CX-60"],
    "××™×¦×•×‘×™×©×™": ["×××•×˜×œ× ×“×¨", "ASX", "××§×œ×™×¤×¡ ×§×¨×•×¡", "×¡×¤×™×™×¡ ×¡×˜××¨"],
    "××¨×¦×“×¡": ["A-Class", "C-Class", "E-Class", "GLA", "GLC", "GLE"],
    "× ×™×¡××Ÿ": ["××™×§×¨×”", "×’'×•×§", "×§×©×§××™", "××§×¡-×˜×¨×™×™×œ", "×¡× ×˜×¨×”"],
    "×¡×•×‘××¨×•": ["XV", "×¤×•×¨×¡×˜×¨", "×××•×˜×‘×§", "×§×¨×•×¡×˜×¨×§"],
    "×¡×•×–×•×§×™": ["×¡×•×•×™×¤×˜", "××™×’× ×™×¡", "×•×™×˜××¨×”", "×§×¨×•×¡××•×‘×¨", "×’'×™×× ×™"],
    "×¡×™××˜": ["××™×‘×™×–×”", "×œ××•×Ÿ", "××¨×•× ×”", "××˜×§×”"],
    "×¡×™×˜×¨×•××Ÿ": ["C3", "C4", "C5 ××™×™×¨×§×¨×•×¡", "×‘×¨×œ×™× ×’×•"],
    "×¡×§×•×“×”": ["×¤××‘×™×”", "××•×§×˜×‘×™×”", "×¡×•×¤×¨×‘", "×§×××™×§", "×§××¨×•×§", "×§×•×“×™××§"],
    "×¤×•×œ×§×¡×•×•×’×Ÿ": ["×¤×•×œ×•", "×’×•×œ×£", "×˜×™×’×•××Ÿ", "×˜×™-×¨×•×§", "×¤××¡××˜"],
    "×¤×™×’'×•": ["208", "2008", "3008", "5008", "×¤×¨×˜× ×¨"],
    "×§×•×¤×¨×”": ["×¤×•×¨×× ×˜×•×¨", "×œ××•×Ÿ"],
    "×§×™×”": ["×¤×™×§× ×˜×•", "×¨×™×•", "×¤×•×¨×˜×”", "×¡×¤×•×¨×˜××–'", "× ×™×¨×•", "×¡×˜×•× ×™×§", "×¡×•×¨× ×˜×•"],
    "×¨× ×•": ["×§×œ×™××•", "×§×¤×¦'×•×¨", "××’××Ÿ", "××¨×§× ×”", "×§× ×’×•"],
    "×©×‘×¨×•×œ×˜": ["×¡×¤××¨×§", "×˜×¨××§×¡", "××§×•×•×™× ×•×§×¡", "×¡×™×œ×‘×¨×“×•"]
};

const checklistData = {
    "×× ×•×¢ ×•× ×•×–×œ×™×": [
        { name: "××¤×œ×¡ ×•××™×›×•×ª ×©××Ÿ", tip: "×‘×“×•×§ ××“×™×“. ×©××Ÿ ×¦×¨×™×š ×œ×”×™×•×ª ×‘×™×Ÿ ×”×§×•×•×™×. ×¦×‘×¢ ×—×•×-×©×—×•×¨ × ×§×™. ×”×™×–×”×¨ ×'×˜×—×™× ×”' (××™× ×‘×©××Ÿ)." },
        { name: "× ×•×–×œ ×§×™×¨×•×¨", tip: "×‘×“×•×§ ×‘××™×›×œ ×¤×œ×¡×˜×™×§ (×œ× ×›×©×”×× ×•×¢ ×—×!). ×”××™× ×¦×¨×™×›×™× ×œ×”×™×•×ª ×¦×‘×¢×•× ×™×™× ×•×œ× ×—×•××™× ××—×œ×•×“×”." },
        { name: "× ×–×™×œ×•×ª ×©××Ÿ/××™×", tip: "×”×¡×ª×›×œ ××¡×‘×™×‘ ×œ×× ×•×¢ ×•××ª×—×ª×™×•. ×—×¤×© ×¨×˜×™×‘×•×ª ×˜×¨×™×” ××• ×¡×™×× ×™ ×©××Ÿ × ×•×–×œ." }
    ],
    "××¨×›×‘ ×•×©×œ×“×”": [
        { name: "×”×¤×¨×©×™ ×’×•×•×Ÿ ×•×¦×‘×¢", tip: "×”×¡×ª×›×œ ×¢×œ ×”×¨×›×‘ ×‘×©××© ××”×¦×“. ×”×× ×™×© ×“×œ×ª ×©× ×¨××™×ª ×§×¦×ª ×™×•×ª×¨ ×›×”×”/×‘×”×™×¨×”? ××¢×™×“ ×¢×œ ×ª×™×§×•×Ÿ ×ª××•× ×”." },
        { name: "×§×•×¨×•×ª ×©×œ×“×”", tip: "×¤×ª×— ××›×¡×” ×× ×•×¢. ×—×¤×© ×¡×™×× ×™ ×¨×™×ª×•×š ×œ× ××§×•×¨×™×™× ××• ××¢×™×›×•×ª ×¢×œ ×”×‘×¨×–×œ×™× ×”×¤× ×™××™×™×." },
        { name: "××¦×‘ ×¦××™×’×™×", tip: "×—×¤×© ×ª××¨×™×š ×™×™×¦×•×¨ (4 ×¡×¤×¨×•×ª). ×¦××™×’ ××¢×œ 4 ×©× ×™× ××• ×¡×“×•×§ ×“×•×¨×© ×”×—×œ×¤×” ××™×™×“×™×ª." }
    ],
    "×—×©××œ ×•×¤× ×™×": [
        { name: "××–×’×Ÿ (×§×•×¨/×—×•×)", tip: "×”×¤×¢×œ ×¢×œ ××§×¡×™××•× ×§×•×¨. ×¦×¨×™×š ×œ×”×•×¦×™× ××•×•×™×¨ ×§×¨ ×××•×“ ×ª×•×š ×“×§×”." },
        { name: "× ×•×¨×•×ª ××–×”×¨×”", tip: "×•×“× ×©×›×œ ×”× ×•×¨×•×ª ×‘×œ×•×— ×”××—×•×•× ×™× × ×›×‘×•×ª ×œ××—×¨ ×”× ×¢×” (Check Engine, ×›×¨×™×•×ª ××•×•×™×¨ ×•×›×•')." },
        { name: "×’×™×¨ (×©×™×œ×•×‘ ×—×œ×§)", tip: "×”×¢×‘×¨ ×‘×™×Ÿ P, R, D. ×”××¢×‘×¨ ×¦×¨×™×š ×œ×”×™×•×ª ×—×œ×§ ×œ×œ× ××›×” ×—×–×§×” ××• ×¨×¢×© ×—×¨×™×’." }
    ]
};

// ××ª×—×•×œ ×™×¦×¨× ×™×
const brandSel = document.getElementById('brand');
Object.keys(carDatabase).sort().forEach(b => brandSel.innerHTML += `<option value="${b}">${b}</option>`);

function updateModels() {
    const b = brandSel.value;
    const mSel = document.getElementById('model');
    mSel.innerHTML = '<option value="">×‘×—×¨ ×“×’×...</option>';
    if (b) {
        mSel.disabled = false;
        carDatabase[b].forEach(m => mSel.innerHTML += `<option value="${m}">${m}</option>`);
    } else mSel.disabled = true;
}

// ××™×ª×•×¨ ×¨×›×‘ ××©×•×œ×‘ (×œ×§×•×— + ×’×™×‘×•×™ ×©×¨×ª)
async function getCarDetails() {
    let p = document.getElementById('plate').value.replace(/\D/g,'');
    if (p.length < 7) return alert("×œ×•×—×™×ª ×§×¦×¨×” ××“×™");
    showLdr("×¡×•×¨×§ ×××’×¨×™ ×××©×œ×”...");
    
    try {
        const govUrl = `https://data.gov.il/api/3/action/datastore_search?resource_id=053ad243-5e8b-4334-8397-47883b740881&q=${p}`;
        const res = await fetch(govUrl);
        const d = await res.json();
        
        if (d.result && d.result.records.length > 0) {
            fillData(d.result.records[0]);
        } else {
            // × ×™×¡×™×•×Ÿ ×’×™×‘×•×™ ×“×¨×š ×”×©×¨×ª
            const srvRes = await fetch('/get-car-details', {
                method: 'POST', headers: {'Content-Type':'application/json'},
                body: JSON.stringify({ plate: p })
            });
            const srvData = await srvRes.json();
            if (srvData.success) fillData(srvData.data);
            else alert("×”×¨×›×‘ ×œ× × ××¦× ×‘×××’×¨. ×× × ××œ× ×™×“× ×™×ª.");
        }
    } catch(e) { alert("×‘×¢×™×™×ª ×ª×§×©×•×¨×ª ×œ×××’×¨. ×”×–×Ÿ ×¤×¨×˜×™× ×™×“× ×™×ª."); }
    finally { hideLdr(); }
}

function fillData(c) {
    document.getElementById('year').value = c.shnat_yitzur || c.SHNAT_YITZUR;
    const govBrand = c.tozeret_nm || c.TOZERET_NM;
    for (let opt of brandSel.options) {
        if (govBrand.includes(opt.value) && opt.value !== "") {
            brandSel.value = opt.value;
            updateModels();
            break;
        }
    }
    document.getElementById('status-msg').innerHTML = "<span style='color:var(--success)'>âœ… × ××¦×!</span>";
}

async function analyzeAI() {
    const b = brandSel.value, m = document.getElementById('model').value, y = document.getElementById('year').value;
    if (!b || !m) return alert("×× × ×‘×—×¨ ×™×¦×¨×Ÿ ×•×“×’×");
    showLdr("AI ×× ×ª×— ×ª×§×œ×•×ª × ×¤×•×¦×•×ª...");
    try {
        const res = await fetch('/analyze-ai', {
            method:'POST', headers:{'Content-Type':'application/json'},
            body: JSON.stringify({brand:b, model:m, year:y})
        });
        const data = await res.json();
        if (data.success) {
            const aiDiv = document.getElementById('ai-result');
            aiDiv.style.display = 'block';
            aiDiv.innerHTML = `<strong>×¡×™×›×•× ×××™× ×•×ª AI:</strong><br>${data.aiAnalysis.replace(/\n/g, '<br>')}`;
            setTimeout(() => goToInspection(), 3000); // ××¢×‘×¨ ××•×˜×•××˜×™ ××—×¨×™ 3 ×©× ×™×•×ª
        } else if (data.error === "TOO_MANY_REQUESTS") {
            alert("×”-AI ×¢××•×¡ ×›×¨×’×¢. × ×¡×” ×©×•×‘ ×‘×¢×•×“ ×“×§×”, ××• ×”××©×š ×œ×‘×“×™×§×” ×™×“× ×™×ª.");
        }
    } catch(e) { alert("×©×’×™××ª AI. × ×™×ª×Ÿ ×œ×”××©×™×š ×œ×‘×“×™×§×” ×™×“× ×™×ª."); }
    finally { hideLdr(); }
}

function goToInspection() {
    document.getElementById('screen-input').style.display = 'none';
    document.getElementById('screen-check').style.display = 'block';
    document.getElementById('check-car-name').innerText = brandSel.value + " " + document.getElementById('model').value;
    renderChecklist();
    window.scrollTo(0,0);
}

function renderChecklist() {
    let h = "";
    let i = 0;
    for (let cat in checklistData) {
        h += `<div class="category">${cat}</div>`;
        checklistData[cat].forEach(item => {
            i++;
            h += `
                <div class="check-item">
                    <div class="item-label" onclick="toggleCB(${i})">
                        <div class="cb" id="cb_${i}"></div>
                        <span>${item.name}</span>
                    </div>
                    <div class="info-btn" onclick="toggleTip(${i})">?</div>
                </div>
                <div class="tooltip" id="tip_${i}">${item.tip}</div>
            `;
        });
    }
    document.getElementById('checklist-content').innerHTML = h;
}

function toggleCB(id) { document.getElementById('cb_'+id).classList.toggle('checked'); }
function toggleTip(id) { 
    const t = document.getElementById('tip_'+id);
    t.style.display = (t.style.display === 'block') ? 'none' : 'block';
}

function calculateScore() {
    const total = document.querySelectorAll('.cb').length;
    const bad = document.querySelectorAll('.cb.checked').length;
    const score = Math.max(0, 100 - Math.round((bad / total) * 100));
    
    document.getElementById('final-score').innerText = score;
    const msg = document.getElementById('score-msg'), desc = document.getElementById('score-desc');
    
    if (score > 85) { msg.innerText = "×¨×›×‘ ×‘××¦×‘ ××¦×•×™×Ÿ!"; desc.innerText = "×”×œ×™×§×•×™×™× ×©× ××¦××• ×–× ×™×—×™× ×œ×—×œ×•×˜×™×Ÿ."; }
    else if (score > 65) { msg.innerText = "×¨×›×‘ ×‘××¦×‘ ×¡×‘×™×¨"; desc.innerText = "×™×©× × ××¡×¤×¨ ×¨×™×’'×§×˜×™× ×©×“×•×¨×©×™× ×”×ª×™×™×—×¡×•×ª ×‘××•×¡×š."; }
    else { msg.innerText = "××¦×‘ ×™×¨×•×“ - ×–×”×™×¨×•×ª!"; desc.innerText = "×œ× ××•××œ×¥ ×œ×”×ª×§×“× ×œ×œ× ×‘×“×™×§×ª ××¢×‘×“×” ××¢××™×§×”."; }
    
    document.getElementById('score-overlay').style.display = 'flex';
}

function showLdr(t) { document.getElementById('loader-text').innerText = t; document.getElementById('loader').style.display = 'flex'; }
function hideLdr() { document.getElementById('loader').style.display = 'none'; }
</script>
</body>
</html>
